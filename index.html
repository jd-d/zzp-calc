<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="assets/favicon.png" type="image/png" />
  <link rel="apple-touch-icon" href="assets/favicon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Clash+Display:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <title>Course Pricing Calculator</title>
  <style>
    :root {
      color-scheme: dark;
      --bg-gradient: radial-gradient(circle at top left, #1e2330, #10131c 55%, #0a0c12 100%);
      --font-body: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      --font-heading: "Clash Display", "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      --card-bg: rgba(20, 24, 35, 0.85);
      --card-border: rgba(255, 255, 255, 0.08);
      --card-border-gradient: linear-gradient(
        135deg,
        rgba(77, 163, 255, 0.6),
        rgba(149, 114, 255, 0.45)
      );
      --card-surface-gradient: linear-gradient(
        160deg,
        rgba(255, 255, 255, 0.08),
        rgba(255, 255, 255, 0.02)
      );
      --card-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
      --accent: #4da3ff;
      --text-primary: #f5f7fb;
      --text-muted: #b1b7c7;
      --field-bg: rgba(7, 9, 14, 0.75);
      --field-border: rgba(255, 255, 255, 0.15);
      --field-output-bg: rgba(77, 163, 255, 0.18);
      --field-output-border: rgba(77, 163, 255, 0.5);
      --field-output-color: #e5f1ff;
      --table-header-bg: rgba(255, 255, 255, 0.04);
      --table-header-text: var(--text-muted);
      --table-row-border: rgba(255, 255, 255, 0.07);
      --row-header-bg: rgba(255, 255, 255, 0.02);
      --price-line-bg: rgba(255, 255, 255, 0.03);
      --price-line-border: rgba(255, 255, 255, 0.05);
      --price-buffer-bg: rgba(77, 163, 255, 0.08);
      --price-buffer-border: rgba(77, 163, 255, 0.25);
      --breakdown-color-vat: #f97316;
      --breakdown-color-variable: #8b5cf6;
      --breakdown-color-fixed: #38bdf8;
      --breakdown-color-tax: #ef4444;
      --breakdown-color-net: #22c55e;
      --button-bg: #f1f5ff;
      --button-color: #0c111d;
      --button-shadow: rgba(0, 0, 0, 0.3);
      --secondary-button-bg: rgba(77, 163, 255, 0.15);
      --secondary-button-border: rgba(77, 163, 255, 0.45);
      --secondary-button-hover-bg: rgba(77, 163, 255, 0.25);
      --info-bg: rgba(77, 163, 255, 0.15);
      --info-border: rgba(77, 163, 255, 0.35);
      --info-hover-bg: rgba(77, 163, 255, 0.25);
      --info-hover-border: rgba(77, 163, 255, 0.55);
      --tooltip-bg: rgba(12, 16, 26, 0.95);
      --tooltip-color: var(--text-primary);
      --tooltip-shadow: 0 12px 24px rgba(0, 0, 0, 0.35);
      --toggle-track: rgba(255, 255, 255, 0.25);
      --toggle-track-border: rgba(255, 255, 255, 0.35);
      --toggle-thumb: var(--accent);
      --toggle-thumb-shadow: rgba(0, 0, 0, 0.35);
      --focus-ring: rgba(77, 163, 255, 0.25);
      --focus-outline: rgba(77, 163, 255, 0.55);
      --inactive-bg: rgba(255, 76, 96, 0.12);
      --inactive-border: rgba(255, 76, 96, 0.45);
      --inactive-text: #ff93a6;
      --inactive-strong: #ffb7c3;
      --active-bg: rgba(77, 163, 255, 0.12);
      --active-border: rgba(77, 163, 255, 0.45);
    }

    body[data-theme="light"] {
      color-scheme: light;
      --bg-gradient: radial-gradient(circle at top left, #eff4ff, #dde7ff 55%, #d4e0ff 100%);
      --font-body: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      --font-heading: "Clash Display", "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      --card-bg: rgba(255, 255, 255, 0.92);
      --card-border: rgba(15, 23, 42, 0.08);
      --card-border-gradient: linear-gradient(
        135deg,
        rgba(37, 99, 235, 0.35),
        rgba(59, 130, 246, 0.15)
      );
      --card-surface-gradient: linear-gradient(
        160deg,
        rgba(255, 255, 255, 0.95),
        rgba(249, 250, 255, 0.85)
      );
      --card-shadow: 0 20px 40px rgba(15, 23, 42, 0.12);
      --accent: #2563eb;
      --text-primary: #111827;
      --text-muted: #4b5563;
      --field-bg: rgba(255, 255, 255, 0.85);
      --field-border: rgba(15, 23, 42, 0.14);
      --field-output-bg: rgba(37, 99, 235, 0.14);
      --field-output-border: rgba(37, 99, 235, 0.35);
      --field-output-color: #0b162d;
      --table-header-bg: rgba(37, 99, 235, 0.08);
      --table-header-text: #1f2937;
      --table-row-border: rgba(15, 23, 42, 0.08);
      --row-header-bg: rgba(226, 232, 240, 0.6);
      --price-line-bg: rgba(15, 23, 42, 0.04);
      --price-line-border: rgba(15, 23, 42, 0.1);
      --price-buffer-bg: rgba(37, 99, 235, 0.12);
      --price-buffer-border: rgba(37, 99, 235, 0.28);
      --breakdown-color-vat: #ea580c;
      --breakdown-color-variable: #7c3aed;
      --breakdown-color-fixed: #2563eb;
      --breakdown-color-tax: #dc2626;
      --breakdown-color-net: #16a34a;
      --button-bg: #1d4ed8;
      --button-color: #f8fafc;
      --button-shadow: rgba(29, 78, 216, 0.3);
      --secondary-button-bg: rgba(37, 99, 235, 0.12);
      --secondary-button-border: rgba(37, 99, 235, 0.3);
      --secondary-button-hover-bg: rgba(37, 99, 235, 0.22);
      --info-bg: rgba(37, 99, 235, 0.12);
      --info-border: rgba(37, 99, 235, 0.32);
      --info-hover-bg: rgba(37, 99, 235, 0.2);
      --info-hover-border: rgba(37, 99, 235, 0.45);
      --tooltip-bg: rgba(15, 23, 42, 0.95);
      --tooltip-color: #f8fafc;
      --tooltip-shadow: 0 18px 36px rgba(15, 23, 42, 0.24);
      --toggle-track: rgba(15, 23, 42, 0.12);
      --toggle-track-border: rgba(15, 23, 42, 0.22);
      --toggle-thumb: #1d4ed8;
      --toggle-thumb-shadow: rgba(15, 23, 42, 0.25);
      --focus-ring: rgba(37, 99, 235, 0.28);
      --focus-outline: rgba(37, 99, 235, 0.55);
      --inactive-bg: rgba(239, 68, 68, 0.12);
      --inactive-border: rgba(220, 38, 38, 0.35);
      --inactive-text: #c53030;
      --inactive-strong: #e53e3e;
      --active-bg: rgba(37, 99, 235, 0.12);
      --active-border: rgba(37, 99, 235, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-body);
      line-height: 1.65;
      background: var(--bg-gradient);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      transition: background 0.4s ease, color 0.4s ease;
    }

    body.dialog-open {
      overflow: hidden;
    }

    body[data-theme="dark"] {
      color-scheme: dark;
    }

    h1,
    h2 {
      font-family: var(--font-heading);
      font-weight: 500;
      letter-spacing: -0.01em;
      line-height: 1.15;
      margin: 0;
    }

    a {
      color: inherit;
    }

    .visually-hidden {
      position: absolute !important;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0 0 0 0);
      white-space: nowrap;
      border: 0;
    }

    .top-nav {
      display: flex;
      justify-content: flex-end;
      padding: 8px 0 0;
    }

    .top-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--secondary-button-border);
      background: var(--secondary-button-bg);
      color: var(--text-primary);
      font-size: 0.95rem;
      text-decoration: none;
      transition: background 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
    }

    .top-link::before {
      content: "📘";
      font-size: 1rem;
    }

    .top-link:hover,
    .top-link:focus-visible {
      background: var(--secondary-button-hover-bg);
      border-color: var(--secondary-button-border);
      transform: translateY(-1px);
      outline: none;
      box-shadow: 0 0 0 3px var(--focus-ring);
    }

    .readme-dialog[hidden] {
      display: none;
    }

    .readme-dialog {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .readme-dialog__backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
    }

    .readme-dialog__content {
      position: relative;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      box-shadow: 0 35px 70px var(--card-shadow);
      max-width: min(960px, 92vw);
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .readme-dialog__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 24px;
      border-bottom: 1px solid var(--table-row-border);
      background: var(--row-header-bg);
    }

    .readme-dialog__close {
      appearance: none;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 6px;
      border-radius: 50%;
      line-height: 1;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .readme-dialog__close:hover,
    .readme-dialog__close:focus-visible {
      background: var(--secondary-button-bg);
      color: var(--text-primary);
      outline: none;
      box-shadow: 0 0 0 3px var(--focus-ring);
    }

    .readme-dialog__body {
      padding: 24px;
      overflow-y: auto;
      line-height: 1.6;
      color: var(--text-primary);
      background: var(--field-output-bg);
    }

    .readme-dialog__body h1,
    .readme-dialog__body h2,
    .readme-dialog__body h3,
    .readme-dialog__body h4,
    .readme-dialog__body h5,
    .readme-dialog__body h6 {
      color: var(--text-primary);
      margin-top: 1.4em;
    }

    .readme-dialog__body p,
    .readme-dialog__body li {
      color: var(--text-muted);
    }

    .readme-dialog__body pre {
      background: rgba(0, 0, 0, 0.4);
      padding: 12px 14px;
      border-radius: 12px;
      overflow-x: auto;
      border: 1px solid var(--table-row-border);
    }

    .readme-dialog__body code {
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    }

    .readme-dialog__body a {
      color: var(--accent);
    }

    .readme-dialog__body ul,
    .readme-dialog__body ol {
      padding-left: 1.25em;
    }

    .readme-dialog__body table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5em 0;
    }

    .readme-dialog__body th,
    .readme-dialog__body td {
      border: 1px solid var(--table-row-border);
      padding: 8px 12px;
    }

    .readme-dialog__body blockquote {
      border-left: 3px solid var(--accent);
      margin: 1.2em 0;
      padding: 0.5em 1em;
      color: var(--text-muted);
      background: rgba(0, 0, 0, 0.25);
      border-radius: 12px;
    }

    .readme-status {
      margin: 0;
      color: var(--text-muted);
    }

    .readme-status--error {
      color: var(--inactive-strong);
    }

    @media (max-width: 720px) {
      .top-nav {
        justify-content: center;
      }

      .top-link {
        width: 100%;
        justify-content: center;
      }

      .readme-dialog__content {
        width: 92vw;
        max-height: 92vh;
      }
    }

    .page {
      position: relative;
      overflow: visible;
      isolation: isolate;
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: clamp(16px, 3vw, 32px);
      gap: clamp(16px, 2vw, 24px);
    }

    .page::before {
      content: "";
      position: absolute;
      inset: -40% -20% -60%;
      background: radial-gradient(
          circle at 30% 20%,
          rgba(77, 163, 255, 0.25),
          transparent 55%
        ),
        radial-gradient(circle at 70% 30%, rgba(149, 114, 255, 0.2), transparent 50%),
        radial-gradient(circle at 50% 80%, rgba(77, 163, 255, 0.18), transparent 55%);
      opacity: 0.45;
      filter: blur(0);
      transform: scale(1.05);
      animation: page-backdrop-drift 26s ease-in-out infinite;
      pointer-events: none;
      z-index: -1;
    }

    @keyframes page-backdrop-drift {
      0% {
        transform: scale(1.05) translate3d(-6%, -3%, 0) rotate(0deg);
      }

      50% {
        transform: scale(1.05) translate3d(8%, 6%, 0) rotate(5deg);
      }

      100% {
        transform: scale(1.05) translate3d(-6%, -3%, 0) rotate(0deg);
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .page::before {
        animation: none;
      }
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .persist-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid var(--field-border);
      background: var(--field-output-bg);
      width: 100%;
    }

    .persist-controls__primary {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1 1 60%;
    }

    .persist-checkbox {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      cursor: pointer;
    }

    .persist-checkbox input[type="checkbox"] {
      width: 1.1rem;
      height: 1.1rem;
      accent-color: var(--accent);
    }

    .persist-description {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .persist-controls button {
      flex: 0 0 auto;
      min-width: 150px;
    }

    .header-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 16px;
      border-radius: 999px;
      border: 1px solid var(--secondary-button-border);
      background: var(--secondary-button-bg);
      color: inherit;
      font-weight: 500;
      text-decoration: none;
      transition: background 0.25s ease, border-color 0.25s ease, transform 0.2s ease;
    }

    .header-link:hover,
    .header-link:focus-visible {
      background: var(--secondary-button-hover-bg);
      border-color: var(--secondary-button-border);
      transform: translateY(-1px);
    }

    .header-link:focus-visible {
      outline: 3px solid var(--focus-outline);
      outline-offset: 2px;
    }

    .header-text {
      flex: 1 1 340px;
      min-width: 240px;
      max-width: 720px;
    }

    .header-text p {
      color: var(--text-muted);
      margin: 8px 0 0;
    }

    .layout {
      display: flex;
      gap: 24px;
      flex: 1;
      min-height: 0;
    }

    .card {
      position: relative;
      z-index: 0;
      border-radius: 18px;
      padding: clamp(16px, 2vw, 24px);
      box-shadow: var(--card-shadow);
      backdrop-filter: blur(16px);
      overflow: visible;
      transform: translateY(0);
      transition: transform 0.35s ease, box-shadow 0.4s ease, color 0.4s ease, background 0.4s ease;
    }

    .card::before,
    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
    }

    .card::before {
      padding: 1px;
      background: var(--card-border-gradient);
      opacity: 0.75;
      z-index: -2;
      transition: opacity 0.45s ease;
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      mask-composite: exclude;
    }

    .card::after {
      z-index: -1;
      background: var(--card-bg);
      background-image: var(--card-surface-gradient);
      opacity: 0.95;
      transition: opacity 0.45s ease;
    }

    .card:hover,
    .card:focus-within {
      transform: translateY(-4px);
      box-shadow: var(--card-shadow), 0 18px 36px rgba(77, 163, 255, 0.12);
      z-index: 2;
    }

    .card:hover::before,
    .card:focus-within::before {
      opacity: 1;
    }

    .card:hover::after,
    .card:focus-within::after {
      opacity: 1;
    }

    .privacy-info {
      display: flex;
      flex-direction: column;
      gap: 16px;
      line-height: 1.6;
    }

    .privacy-info h2,
    .privacy-info h3 {
      margin: 0;
    }

    .privacy-info h3 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .privacy-info ol {
      margin: 0;
      padding-left: 1.2rem;
      display: grid;
      gap: 12px;
    }

    .privacy-info li {
      padding-left: 4px;
    }

    .controls {
      flex: 0 0 320px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .controls .control-sections,
    .controls .control-section {
      border: none;
      padding: 0;
      margin: 0;
    }

    .controls .control-sections {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .controls .control-section {
      border: 1px solid var(--card-border);
      border-radius: 16px;
      background: var(--card-surface-gradient);
      padding: 16px 18px 18px;
    }

    .section-legend {
      margin: 0;
      padding: 0;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 0 6px;
      width: 100%;
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      flex: 1 1 auto;
      min-width: 0;
    }

    .section-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 12px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      border-radius: 999px;
      border: 1px solid var(--secondary-button-border);
      background: var(--secondary-button-bg);
      color: var(--text-primary);
      box-shadow: none;
      transform: none;
      white-space: nowrap;
    }

    .section-toggle:hover,
    .section-toggle:focus-visible {
      background: var(--secondary-button-hover-bg);
      border-color: var(--secondary-button-border);
      color: var(--text-primary);
      box-shadow: none;
      transform: none;
    }

    .section-toggle--top {
      flex: 0 0 auto;
    }

    .section-toggle--bottom {
      margin-top: 8px;
    }

    .section-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
    }

    .controls .control-section.collapsed .section-body {
      display: none;
    }

    .controls .control-section .section-body {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 12px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 0;
      border-radius: 14px;
      border: 1px solid transparent;
      background: transparent;
      transition: border-color 0.3s ease, background-color 0.3s ease, padding 0.3s ease;
    }

    .control {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .control--fixed-costs {
      gap: 12px;
      padding: 16px;
      border-radius: 14px;
      border: 1px solid var(--field-border);
      background: var(--field-output-bg);
    }

    .fixed-costs-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .fixed-costs-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .fixed-cost-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-start;
    }

    .fixed-cost-label {
      flex: 1 1 180px;
      font-weight: 500;
    }

    .fixed-cost-inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      flex: 2 1 280px;
    }

    .fixed-cost-inputs label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.85rem;
    }

    .input-label {
      color: var(--text-muted);
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 0.75rem;
    }

    .fixed-cost-total {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding-top: 8px;
      border-top: 1px solid var(--field-border);
    }

    .fixed-cost-resources {
      margin: 4px 0 0;
      padding-left: 20px;
      color: var(--text-muted);
      font-size: 0.85rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .fixed-cost-resources a {
      color: inherit;
      text-decoration: underline;
    }

    .fixed-cost-total input[readonly] {
      cursor: default;
      background: var(--field-output-bg);
    }

    label {
      font-size: 0.95rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .field-note,
    .field-message {
      font-size: 0.85rem;
      margin: 0;
      color: var(--text-muted);
    }

    .field-message:empty {
      display: none;
    }

    .label-text {
      flex: 1 1 auto;
      min-width: 0;
    }

    .info-icon {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 999px;
      font-size: 0.9rem;
      background: var(--info-bg);
      color: var(--accent);
      cursor: pointer;
      border: 1px solid var(--info-border);
      flex: 0 0 auto;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
      touch-action: manipulation;
      --tooltip-shift: 0px;
    }

    .info-icon:hover,
    .info-icon:focus-visible,
    .info-icon.is-active {
      background: var(--info-hover-bg);
      border-color: var(--info-hover-border);
      outline: none;
      color: #fff;
      box-shadow: 0 0 0 3px var(--focus-ring);
    }

    .info-icon__tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translate(calc(-50% + var(--tooltip-shift, 0px)), 4px);
      width: clamp(180px, calc(100vw - 32px), 260px);
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--tooltip-bg);
      color: var(--tooltip-color);
      font-size: 0.8rem;
      line-height: 1.35;
      box-shadow: var(--tooltip-shadow);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease, transform 0.15s ease;
      z-index: 10;
    }

    .info-icon__arrow {
      position: absolute;
      bottom: calc(100% + 4px);
      left: 50%;
      transform: translate(calc(-50% + var(--tooltip-shift, 0px)), 4px);
      border-width: 6px;
      border-style: solid;
      border-color: var(--tooltip-bg) transparent transparent transparent;
      opacity: 0;
      transition: opacity 0.15s ease, transform 0.15s ease;
      pointer-events: none;
    }

    .info-icon:hover .info-icon__tooltip,
    .info-icon:focus-visible .info-icon__tooltip,
    .info-icon.is-active .info-icon__tooltip,
    .info-icon:hover .info-icon__arrow,
    .info-icon:focus-visible .info-icon__arrow,
    .info-icon.is-active .info-icon__arrow {
      opacity: 1;
      transform: translate(calc(-50% + var(--tooltip-shift, 0px)), 0);
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--field-border);
      background: var(--field-bg);
      color: inherit;
      font-size: 1rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
    }

    input[type="number"]:focus,
    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--focus-ring);
    }

    .control output {
      display: block;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 1rem;
      font-variant-numeric: tabular-nums;
    }

    .output-field {
      border: 1px solid var(--field-output-border);
      background: var(--field-output-bg);
      color: var(--field-output-color);
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease, color 0.2s ease;
      color: var(--button-color);
      background: var(--button-bg);
    }

    button:focus-visible {
      outline: 3px solid var(--focus-outline);
      outline-offset: 2px;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px var(--button-shadow);
    }

    button.secondary {
      background: var(--secondary-button-bg);
      color: var(--text-primary);
      border: 1px solid var(--secondary-button-border);
    }

    button.secondary:hover {
      background: var(--secondary-button-hover-bg);
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 6px 14px 6px 10px;
      background: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--card-border);
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 600;
      transform: none;
      box-shadow: none;
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }

    .theme-toggle:hover,
    .theme-toggle:focus-visible {
      transform: none;
      box-shadow: 0 0 0 3px var(--focus-ring);
      background: var(--secondary-button-bg);
      border-color: var(--secondary-button-border);
    }

    .theme-toggle .toggle-track {
      position: relative;
      width: 40px;
      height: 22px;
      border-radius: 999px;
      background: var(--toggle-track);
      border: 1px solid var(--toggle-track-border);
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 6px;
      transition: background 0.3s ease, border-color 0.3s ease;
    }

    .theme-toggle .toggle-track::before,
    .theme-toggle .toggle-track::after {
      font-size: 0.7rem;
      line-height: 1;
      opacity: 0.65;
    }

    .theme-toggle .toggle-track::before {
      content: '🌙';
    }

    .theme-toggle .toggle-track::after {
      content: '☀️';
    }

    body[data-theme="dark"] .theme-toggle .toggle-track::before {
      opacity: 1;
    }

    body[data-theme="dark"] .theme-toggle .toggle-track::after {
      opacity: 0.45;
    }

    body[data-theme="light"] .theme-toggle .toggle-track::before {
      opacity: 0.45;
    }

    body[data-theme="light"] .theme-toggle .toggle-track::after {
      opacity: 1;
    }

    .theme-toggle .toggle-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: var(--toggle-thumb);
      box-shadow: 0 2px 6px var(--toggle-thumb-shadow);
      transition: transform 0.3s ease;
    }

    body[data-theme="dark"] .theme-toggle .toggle-thumb {
      transform: translateX(0);
    }

    body[data-theme="light"] .theme-toggle .toggle-thumb {
      transform: translateX(20px);
    }

    .theme-toggle .toggle-label {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .tables {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 24px;
      min-width: 0;
    }

    .table-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    .table-grid.table-grid--stacked {
      grid-template-columns: minmax(0, 1fr);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-variant-numeric: tabular-nums;
      border-radius: 14px;
      overflow: visible;
    }

    caption {
      text-align: left;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 12px;
    }

    thead th {
      background: var(--table-header-bg);
      padding: 10px 12px;
      text-align: left;
      font-size: 0.9rem;
      color: var(--table-header-text);
    }

    thead th:not(:first-child) {
      text-align: center;
    }

    tbody th,
    tbody td {
      padding: 10px 12px;
      border-top: 1px solid var(--table-row-border);
    }

    tbody th {
      text-align: left;
      font-weight: 600;
      background: var(--row-header-bg);
      color: var(--text-primary);
    }

    tbody td {
      text-align: center;
      line-height: 1.5;
      white-space: nowrap;
    }

    .price-pair {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-start;
    }

    .price-line {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
      padding: 8px 10px;
      border-radius: 10px;
      background: var(--price-line-bg);
      border: 1px solid var(--price-line-border);
      color: inherit;
      transition: border-color 0.2s ease, background-color 0.2s ease,
        transform 0.2s ease, box-shadow 0.2s ease;
    }

    .price-line strong {
      font-size: 1.05rem;
    }

    .price-line .price-label {
      font-size: 0.75rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .price-line .price-secondary {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .price-line.buffered {
      background: var(--price-buffer-bg);
      border-color: var(--price-buffer-border);
    }

    .price-line.base {
      display: none;
      margin-top: 8px;
      border-style: dashed;
    }

    button.price-line {
      width: 100%;
      text-align: left;
      cursor: pointer;
      background: var(--price-line-bg);
      border-radius: 10px;
      border: 1px solid var(--price-line-border);
      color: inherit;
      font: inherit;
      line-height: inherit;
      padding: 8px 10px;
    }

    button.price-line:focus {
      outline: none;
    }

    button.price-line:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    button.price-line:focus-visible {
      outline: 2px solid var(--focus-outline);
      outline-offset: 2px;
      box-shadow: 0 0 0 3px var(--focus-ring);
    }

    .pricing-card.show-base-prices .price-line.base {
      display: flex;
    }

    .price-toggle-row {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 12px;
    }

    .price-reveal-toggle {
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    .sub-label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 400;
      margin-top: 2px;
    }

    .tables .card {
      min-height: 100%;
    }

    ul.assumptions {
      margin: 0;
      padding-left: 20px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .tables-footer {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .status-message {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    @media (max-width: 720px) {
      header {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }

      .header-text {
        flex: 1 1 auto;
        text-align: center;
      }

      .theme-toggle {
        align-self: center;
      }

      .persist-controls {
        flex-direction: column;
        align-items: stretch;
        text-align: left;
      }

      .persist-controls button {
        width: 100%;
      }

      .layout {
        gap: 16px;
      }

      .controls {
        gap: 16px;
      }

      .controls .control-sections {
        order: 1;
      }

      .controls .actions {
        order: 2;
      }

      .controls .status-message {
        order: 3;
      }
    }

    @media (max-width: 960px) {
      .layout {
        flex-direction: column;
      }

      .controls {
        flex-basis: auto;
      }
    }

    @media (max-width: 720px) {
      .header-actions {
        width: 100%;
        justify-content: center;
        gap: 10px;
      }

      .fixed-cost-row {
        gap: 10px;
      }

      .fixed-cost-inputs {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 8px;
      }
    }

    @media (max-width: 520px) {
      .fixed-cost-row {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .fixed-cost-label,
      .fixed-cost-inputs {
        flex: 1 1 auto;
        min-height: auto;
        width: 100%;
      }

      .fixed-cost-inputs {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 520px) {
      .section-header {
        align-items: flex-start;
        flex-direction: column;
        gap: 8px;
      }

      .section-toggle--top {
        align-self: flex-end;
      }

      button:not(.section-toggle) {
        width: 100%;
        justify-content: center;
      }

      .button-row {
        flex-direction: column;
      }

      tbody td {
        white-space: normal;
      }
    }
  </style>
</head>
<body data-theme="dark">
  <div class="page">
    <nav class="top-nav">
      <a href="#" id="how-to-link" class="top-link">How To Use This Tool</a>
    </nav>
    <header>
      <div class="header-text">
        <h1>Course Pricing Calculator</h1>
        <p>Estimate per-student pricing to reach your target income. All calculations stay on this page.</p>
      </div>
      <div class="header-actions">
        <a class="header-link" href="#privacy-info">Your Info Is Safe</a>
        <button type="button" class="theme-toggle" id="theme-toggle" aria-pressed="true">
          <span class="toggle-track" aria-hidden="true">
            <span class="toggle-thumb"></span>
          </span>
          <span class="toggle-label">Dark mode</span>
        </button>
      </div>
    </header>

    <div class="layout">
      <section class="card controls" aria-labelledby="inputs-heading">
        <h2 id="inputs-heading" style="font-size: 1.1rem;">Inputs</h2>
        <fieldset class="control-sections">
          <legend class="visually-hidden">Calculator inputs</legend>

          <fieldset class="control-section" data-collapsible>
            <legend class="section-legend visually-hidden" id="section-settings-legend">Settings</legend>
            <div class="section-header">
              <span class="section-title" aria-hidden="true">Settings</span>
              <button
                type="button"
                class="section-toggle section-toggle--top"
                data-expanded-text="Collapse"
                data-collapsed-text="Expand"
                aria-expanded="true"
                aria-controls="section-settings"
              >
                <span class="toggle-label">Collapse</span>
              </button>
            </div>
            <div class="section-body" id="section-settings">
              <div class="persist-controls" role="group" aria-labelledby="persist-settings-label">
                <div class="persist-controls__primary">
                  <label class="persist-checkbox" id="persist-settings-label" for="remember-inputs">
                    <input type="checkbox" id="remember-inputs" />
                    <span>Remember my inputs on this device</span>
                  </label>
                  <p class="persist-description">
                    Stores your latest calculator values in local storage so they're ready the next time you visit from this browser.
                  </p>
                </div>
                <button type="button" id="reset-saved-inputs" class="secondary">Reset to defaults</button>
              </div>
              <div class="control">
                <label for="currency-symbol">
                  <span class="label-text">Currency symbol</span>
                  <span class="info-icon" tabindex="0" role="button" aria-expanded="false" aria-label="Displayed before amounts." data-tooltip="Displayed before amounts.">ℹ️</span>
                </label>
                <input type="text" id="currency-symbol" value="€" maxlength="3" />
              </div>
            </div>
            <div class="section-footer">
              <button
                type="button"
                class="section-toggle section-toggle--bottom"
                data-expanded-text="Collapse section"
                data-collapsed-text="Expand section"
                aria-expanded="true"
                aria-controls="section-settings"
              >
                <span class="toggle-label">Collapse section</span>
              </button>
            </div>
          </fieldset>

          <fieldset class="control-section" data-collapsible>
            <legend class="section-legend visually-hidden" id="section-net-income-legend">Net income</legend>
            <div class="section-header">
              <span class="section-title" aria-hidden="true">Net income</span>
              <button
                type="button"
                class="section-toggle section-toggle--top"
                data-expanded-text="Collapse"
                data-collapsed-text="Expand"
                aria-expanded="true"
                aria-controls="section-net-income"
              >
                <span class="toggle-label">Collapse</span>
              </button>
            </div>
            <div class="section-body" id="section-net-income">
              <div class="control-group">
                <p class="field-note">Entering a net income value will update the lesson cost automatically.</p>
                <div class="control">
                  <label for="target-net">
                    <span class="label-text">Net income per year</span>
                    <span class="info-icon" tabindex="0" role="button" aria-expanded="false" aria-label="Amount you want to take home after income taxes." data-tooltip="Amount you want to take home after income taxes.">ℹ️</span>
                  </label>
                  <input type="number" id="target-net" value="50000" min="0" step="100" inputmode="decimal" />
                </div>
                <div class="control">
                  <label for="target-net-week">
                    <span class="label-text">Net income per active week</span>
                    <span
                      class="info-icon"
                      tabindex="0"
                      role="button" aria-expanded="false"
                      aria-label="Weeks you are actively teaching after factoring in planned time off."
                      data-tooltip="Weeks you are actively teaching after factoring in planned time off."
                    >ℹ️</span>
                  </label>
                  <input type="number" id="target-net-week" value="2000" min="0" step="50" inputmode="decimal" />
                </div>
                <div class="control">
                  <label for="target-net-month">
                    <span class="label-text">Net income per active month</span>
                    <span
                      class="info-icon"
                      tabindex="0"
                      role="button" aria-expanded="false"
                      aria-label="Active months exclude the time off set below."
                      data-tooltip="Active months exclude the time off set below."
                    >ℹ️</span>
                  </label>
                  <input type="number" id="target-net-month" value="5000" min="0" step="100" inputmode="decimal" />
                </div>
                <div class="control">
                  <label for="target-net-average-week">
                    <span class="label-text">Average weekly net income</span>
                    <span
                      class="info-icon"
                      tabindex="0"
                      role="button" aria-expanded="false"
                      aria-label="Average over every week in the year, including planned time off."
                      data-tooltip="Average over every week in the year, including planned time off."
                    >ℹ️</span>
                  </label>
                  <input type="number" id="target-net-average-week" value="961.54" min="0" step="10" inputmode="decimal" />
                </div>
                <div class="control">
                  <label for="target-net-average-month">
                    <span class="label-text">Average monthly net income</span>
                    <span
                      class="info-icon"
                      tabindex="0"
                      role="button" aria-expanded="false"
                      aria-label="Average over every month in the year, including planned time off."
                      data-tooltip="Average over every month in the year, including planned time off."
                    >ℹ️</span>
                  </label>
                  <input type="number" id="target-net-average-month" value="4166.67" min="0" step="50" inputmode="decimal" />
                </div>
              </div>
              <div class="section-footer">
                <button
                  type="button"
                  class="section-toggle section-toggle--bottom"
                  data-expanded-text="Collapse section"
                  data-collapsed-text="Expand section"
                  aria-expanded="true"
                  aria-controls="section-net-income"
                >
                  <span class="toggle-label">Collapse section</span>
                </button>
              </div>
            </div>
          </fieldset>

          <fieldset class="control-section" data-collapsible>
            <legend class="section-legend visually-hidden" id="section-safety-margin-legend">Safety margin</legend>
            <div class="section-header">
              <span class="section-title" aria-hidden="true">Safety margin</span>
              <button
                type="button"
                class="section-toggle section-toggle--top"
                data-expanded-text="Collapse"
                data-collapsed-text="Expand"
                aria-expanded="true"
                aria-controls="section-safety-margin"
              >
                <span class="toggle-label">Collapse</span>
              </button>
            </div>
            <div class="section-body" id="section-safety-margin">
              <p class="field-note">
                Add a percentage cushion on top of your desired net income. The buffered line in the results uses this value to suggest a price that covers surprises.
              </p>
              <div class="control">
                <label for="buffer">
                  <span class="label-text">Safety margin cushion (%)</span>
                  <span
                    class="info-icon"
                    tabindex="0"
                    role="button"
                    aria-expanded="false"
                    aria-label="Adds a cushion to your desired income. The buffered pricing line uses this percentage."
                    data-tooltip="Adds a cushion to your desired income. The buffered pricing line uses this percentage."
                  >ℹ️</span>
                </label>
                <input type="number" id="buffer" value="15" min="0" step="1" inputmode="decimal" />
              </div>
            </div>
            <div class="section-footer">
              <button
                type="button"
                class="section-toggle section-toggle--bottom"
                data-expanded-text="Collapse section"
                data-collapsed-text="Expand section"
                aria-expanded="true"
                aria-controls="section-safety-margin"
              >
                <span class="toggle-label">Collapse section</span>
              </button>
            </div>
          </fieldset>

          <fieldset class="control-section" data-collapsible>
            <legend class="section-legend visually-hidden" id="section-taxes-costs-legend">Taxes and costs</legend>
            <div class="section-header">
              <span class="section-title" aria-hidden="true">Taxes and costs</span>
              <button
                type="button"
                class="section-toggle section-toggle--top"
                data-expanded-text="Collapse"
                data-collapsed-text="Expand"
                aria-expanded="true"
                aria-controls="section-taxes-costs"
              >
                <span class="toggle-label">Collapse</span>
              </button>
            </div>
            <div class="section-body" id="section-taxes-costs">
              <div class="control">
                <label for="tax-rate">
                  <span class="label-text">Effective income tax rate (%)</span>
                  <span class="info-icon" tabindex="0" role="button" aria-expanded="false" aria-label="Share of profit paid in taxes and social charges." data-tooltip="Share of profit paid in taxes and social charges.">ℹ️</span>
                </label>
                <input type="number" id="tax-rate" value="40" min="0" max="99" step="1" inputmode="decimal" />
              </div>
              <div class="control control--fixed-costs">
                <div class="fixed-costs-header">
                  <span class="label-text">Fixed costs</span>
                  <span
                    class="info-icon"
                    tabindex="0"
                    role="button"
                    aria-expanded="false"
                    aria-label="Break down ongoing expenses like venue, insurance, pension, health cover, marketing, materials, and admin."
                    data-tooltip="Break down ongoing expenses like venue, insurance, pension, health cover, marketing, materials, and admin."
                  >ℹ️</span>
                </div>
                <p class="field-note">
                  Enter either the monthly or annual amount for each category. The other column updates automatically. Think about rent, business insurance, disability cover (AOV), pension contributions, health insurance, marketing, materials, software, and training.
                </p>
                <div class="fixed-costs-grid">
                  <div class="fixed-cost-row">
                    <div class="fixed-cost-label">Location / venue</div>
                    <div class="fixed-cost-inputs">
                      <label for="fixed-cost-location-monthly">
                        <span class="input-label">Monthly</span>
                        <input type="number" id="fixed-cost-location-monthly" value="650" min="0" step="0.01" inputmode="decimal" />
                      </label>
                      <label for="fixed-cost-location-annual">
                        <span class="input-label">Annual</span>
                        <input type="number" id="fixed-cost-location-annual" value="7800" min="0" step="0.01" inputmode="decimal" />
                      </label>
                    </div>
                  </div>
                  <div class="fixed-cost-row">
                    <div class="fixed-cost-label">Business insurance</div>
                    <div class="fixed-cost-inputs">
                      <label for="fixed-cost-insurance-monthly">
                        <span class="input-label">Monthly</span>
                        <input type="number" id="fixed-cost-insurance-monthly" value="100" min="0" step="0.01" inputmode="decimal" />
                      </label>
                      <label for="fixed-cost-insurance-annual">
                        <span class="input-label">Annual</span>
                        <input type="number" id="fixed-cost-insurance-annual" value="1200" min="0" step="0.01" inputmode="decimal" />
                      </label>
                    </div>
                  </div>
                  <div class="fixed-cost-row">
                    <div class="fixed-cost-label">Disability insurance (AOV)</div>
                    <div class="fixed-cost-inputs">
                      <label for="fixed-cost-disability-monthly">
                        <span class="input-label">Monthly</span>
                        <input type="number" id="fixed-cost-disability-monthly" value="220" min="0" step="0.01" inputmode="decimal" />
                      </label>
                      <label for="fixed-cost-disability-annual">
                        <span class="input-label">Annual</span>
                        <input type="number" id="fixed-cost-disability-annual" value="2640" min="0" step="0.01" inputmode="decimal" />
                      </label>
                    </div>
                  </div>
                  <div class="fixed-cost-row">
                    <div class="fixed-cost-label">Health insurance premium</div>
                    <div class="fixed-cost-inputs">
                      <label for="fixed-cost-health-monthly">
                        <span class="input-label">Monthly</span>
                        <input type="number" id="fixed-cost-health-monthly" value="150" min="0" step="0.01" inputmode="decimal" />
                      </label>
                      <label for="fixed-cost-health-annual">
                        <span class="input-label">Annual</span>
                        <input type="number" id="fixed-cost-health-annual" value="1800" min="0" step="0.01" inputmode="decimal" />
                      </label>
                    </div>
                  </div>
                  <div class="fixed-cost-row">
                    <div class="fixed-cost-label">Pension contributions</div>
                    <div class="fixed-cost-inputs">
                      <label for="fixed-cost-pension-monthly">
                        <span class="input-label">Monthly</span>
                        <input type="number" id="fixed-cost-pension-monthly" value="250" min="0" step="0.01" inputmode="decimal" />
                      </label>
                      <label for="fixed-cost-pension-annual">
                        <span class="input-label">Annual</span>
                        <input type="number" id="fixed-cost-pension-annual" value="3000" min="0" step="0.01" inputmode="decimal" />
                      </label>
                    </div>
                  </div>
                  <div class="fixed-cost-row">
                    <div class="fixed-cost-label">Marketing</div>
                    <div class="fixed-cost-inputs">
                      <label for="fixed-cost-marketing-monthly">
                        <span class="input-label">Monthly</span>
                        <input type="number" id="fixed-cost-marketing-monthly" value="300" min="0" step="0.01" inputmode="decimal" />
                      </label>
                      <label for="fixed-cost-marketing-annual">
                        <span class="input-label">Annual</span>
                        <input type="number" id="fixed-cost-marketing-annual" value="3600" min="0" step="0.01" inputmode="decimal" />
                      </label>
                    </div>
                  </div>
                  <div class="fixed-cost-row">
                    <div class="fixed-cost-label">Materials</div>
                    <div class="fixed-cost-inputs">
                      <label for="fixed-cost-materials-monthly">
                        <span class="input-label">Monthly</span>
                        <input type="number" id="fixed-cost-materials-monthly" value="150" min="0" step="0.01" inputmode="decimal" />
                      </label>
                      <label for="fixed-cost-materials-annual">
                        <span class="input-label">Annual</span>
                        <input type="number" id="fixed-cost-materials-annual" value="1800" min="0" step="0.01" inputmode="decimal" />
                      </label>
                    </div>
                  </div>
                  <div class="fixed-cost-row">
                    <div class="fixed-cost-label">Admin / software</div>
                    <div class="fixed-cost-inputs">
                      <label for="fixed-cost-admin-monthly">
                        <span class="input-label">Monthly</span>
                        <input type="number" id="fixed-cost-admin-monthly" value="175" min="0" step="0.01" inputmode="decimal" />
                      </label>
                      <label for="fixed-cost-admin-annual">
                        <span class="input-label">Annual</span>
                        <input type="number" id="fixed-cost-admin-annual" value="2100" min="0" step="0.01" inputmode="decimal" />
                      </label>
                    </div>
                  </div>
                  <div class="fixed-cost-row">
                    <div class="fixed-cost-label">Professional development</div>
                    <div class="fixed-cost-inputs">
                      <label for="fixed-cost-development-monthly">
                        <span class="input-label">Monthly</span>
                        <input type="number" id="fixed-cost-development-monthly" value="100" min="0" step="0.01" inputmode="decimal" />
                      </label>
                      <label for="fixed-cost-development-annual">
                        <span class="input-label">Annual</span>
                        <input type="number" id="fixed-cost-development-annual" value="1200" min="0" step="0.01" inputmode="decimal" />
                      </label>
                    </div>
                  </div>
                </div>
                <ul class="fixed-cost-resources">
                  <li>
                    <a href="https://www.kvk.nl/financiering/bereken-uw-uurtarief-als-zzper/" target="_blank" rel="noreferrer noopener">KVK on calculating your ZZP hourly rate</a> – overview of common Dutch freelancer expenses.
                  </li>
                  <li>
                    <a href="https://www.independer.nl/pensioen/zelfstandig/pensioen-zzp.aspx" target="_blank" rel="noreferrer noopener">Independer pension comparison for ZZP’ers</a> – compare third pillar pension products.
                  </li>
                  <li>
                    <a href="https://www.zzp-nederland.nl/verzekeringen/arbeidsongeschiktheidsverzekering" target="_blank" rel="noreferrer noopener">ZZP Nederland on AOV insurance</a> – explains coverage options and premiums.
                  </li>
                  <li>
                    <a href="https://www.zorgwijzer.nl/zorgverzekering/zzp" target="_blank" rel="noreferrer noopener">Zorgwijzer health insurance guide for ZZP’ers</a> – compares zorgverzekeringen with business deductions in mind.
                  </li>
                </ul>
                <div class="fixed-cost-total">
                  <label for="fixed-costs">
                    <span class="label-text">Total fixed annual costs</span>
                  </label>
                  <input type="number" id="fixed-costs" value="25140" min="0" step="0.01" inputmode="decimal" readonly />
                  <p class="field-note">Calculated automatically from the breakdown above.</p>
                </div>
              </div>
              <div class="control">
                <label for="variable-cost-class">
                  <span class="label-text">Variable cost per working day</span>
                  <span class="info-icon" tabindex="0" role="button" aria-expanded="false" aria-label="Expenses that apply on days you operate, such as travel, supplies, or subcontractors." data-tooltip="Expenses that apply on days you operate, such as travel, supplies, or subcontractors.">ℹ️</span>
                </label>
                <input type="number" id="variable-cost-class" value="0" min="0" step="0.01" inputmode="decimal" />
              </div>
              <div class="control">
                <label for="vat-rate">
                  <span class="label-text">VAT rate (%)</span>
                  <span class="info-icon" tabindex="0" role="button" aria-expanded="false" aria-label="Modify if the services you offer fall into a lower VAT band." data-tooltip="Modify if the services you offer fall into a lower VAT band.">ℹ️</span>
                </label>
                <input type="number" id="vat-rate" value="21" min="0" step="0.1" inputmode="decimal" />
              </div>
              <div class="section-footer">
                <button
                  type="button"
                  class="section-toggle section-toggle--bottom"
                  data-expanded-text="Collapse section"
                  data-collapsed-text="Expand section"
                  aria-expanded="true"
                  aria-controls="section-taxes-costs"
                >
                  <span class="toggle-label">Collapse section</span>
                </button>
              </div>
            </div>
          </fieldset>

          

          <fieldset class="control-section" data-collapsible>
            <legend class="section-legend visually-hidden" id="section-time-off-legend">Time-off planner</legend>
            <div class="section-header">
              <span class="section-title" aria-hidden="true">Time-off planner</span>
              <button
                type="button"
                class="section-toggle section-toggle--top"
                data-expanded-text="Collapse"
                data-collapsed-text="Expand"
                aria-expanded="true"
                aria-controls="section-time-off"
              >
                <span class="toggle-label">Collapse</span>
              </button>
            </div>
            <div class="section-body" id="section-time-off">
              <div class="control">
                <label for="months-off">
                  <span class="label-text">Months off per year</span>
                  <span class="info-icon" tabindex="0" role="button" aria-expanded="false" aria-label="Total months you plan to take completely off." data-tooltip="Total months you plan to take completely off.">ℹ️</span>
                </label>
                <input type="number" id="months-off" value="2" min="0" max="12" step="0.5" inputmode="decimal" />
              </div>
              <div class="control">
                <label for="weeks-off-cycle">
                  <span class="label-text">Weeks off per 4-week cycle</span>
                  <span class="info-icon" tabindex="0" role="button" aria-expanded="false" aria-label="For example, 1 week off means working 3 weeks out of every 4." data-tooltip="For example, 1 week off means working 3 weeks out of every 4.">ℹ️</span>
                </label>
                <input type="number" id="weeks-off-cycle" value="1" min="0" max="4" step="0.25" inputmode="decimal" />
              </div>
              <div class="control">
                <label for="days-off-week">
                  <span class="label-text">Days off per week</span>
                  <span class="info-icon" tabindex="0" role="button" aria-expanded="false" aria-label="Defaults to a typical weekend off but supports partial-day values." data-tooltip="Defaults to a typical weekend off but supports partial-day values.">ℹ️</span>
                </label>
                <input type="number" id="days-off-week" value="2" min="0" max="7" step="0.25" inputmode="decimal" />
              </div>
              <div class="control">
                <label>
                  <span class="label-text">Estimated working weeks per year</span>
                  <span class="info-icon" tabindex="0" role="button" aria-expanded="false" aria-label="Calculated from the schedule above." data-tooltip="Calculated from the schedule above.">ℹ️</span>
                </label>
                <output id="working-weeks-display" class="output-field">32.5</output>
              </div>
              <div class="control">
                <label>
                  <span class="label-text">Estimated working days per year</span>
                  <span class="info-icon" tabindex="0" role="button" aria-expanded="false" aria-label="Working weeks × working days per active week." data-tooltip="Working weeks × working days per active week.">ℹ️</span>
                </label>
                <output id="working-days-display" class="output-field">130</output>
              </div>
              <div class="section-footer">
                <button
                  type="button"
                  class="section-toggle section-toggle--bottom"
                  data-expanded-text="Collapse section"
                  data-collapsed-text="Expand section"
                  aria-expanded="true"
                  aria-controls="section-time-off"
                >
                  <span class="toggle-label">Collapse section</span>
                </button>
              </div>
            </div>
          </fieldset>

        </fieldset>
        <div class="button-row actions" role="group" aria-label="Actions">
          <button type="button" id="recalculate">Recalculate</button>
          <button type="button" id="download-csv" class="secondary">Download CSV</button>
        </div>
        <p class="status-message" id="status-message" aria-live="polite"></p>
      </section>

      <section class="tables" aria-live="polite">
        <div class="table-grid" id="tables-container">
          <!-- Tables injected here -->
        </div>
        <div class="tables-footer">
          <h2 style="font-size: 1.05rem; margin: 0;">Assumptions</h2>
          <ul class="assumptions" id="assumptions-list"></ul>
        </div>
      </section>
    </div>

    <section class="card privacy-info" id="privacy-info" aria-labelledby="privacy-heading">
      <div>
        <h2 id="privacy-heading">Your Info Is Safe</h2>
        <p>
          This calculator runs entirely in your browser. There are no sign-ins, accounts, or background network calls. Everything
          you type stays on this page. By default the only thing saved between visits is your light/dark mode preference
          (<code>zzp-calc-theme</code>). If you turn on “Remember my inputs,” the calculator also stores your latest form values
          (<code>zzp-calc-saved-inputs</code>) plus a small flag (<code>zzp-calc-save-enabled</code>) in local storage. Switch it
          off or press “Reset to defaults” to remove them instantly.
        </p>
        <p>
          When you export results, the CSV file is generated on your device: the app assembles the rows, wraps them in a
          <code>Blob</code>, spawns a temporary download link, clicks it for you, and immediately cleans it up again, so nothing
          leaves your device. Want to dig deeper? The full source code is available on
          <a href="https://github.com/jd-d/zzp-calc" target="_blank" rel="noreferrer noopener">GitHub</a>, review it yourself or with a
          developer you trust to confirm exactly how the site works.
        </p>
      </div>
      <div>
        <h3>Easy ways to verify this yourself</h3>
        <ol>
          <li>
            <strong>Check that no cookies are created.</strong> Open DevTools → Application/Storage → Cookies, reload the page,
            and interact with the calculator. The cookies list will stay empty.
          </li>
          <li>
            <strong>Inspect local storage.</strong> In the same panel, open “Local Storage,” select the site origin, and confirm
            you see <code>zzp-calc-theme</code>, plus <code>zzp-calc-saved-inputs</code> and
            <code>zzp-calc-save-enabled</code> only if you enabled “Remember my inputs.” Toggle it off or use “Reset to
            defaults” to clear the extra entries.
          </li>
          <li>
            <strong>Watch for network requests.</strong> Keep the Network tab open with “Preserve log” enabled as you adjust
            inputs and export CSV. You’ll see no additional requests after the initial page load because every
            calculation happens locally.
          </li>
          <li>
            <strong>Review the page source.</strong> Search for calls like <code>fetch</code>, <code>XMLHttpRequest</code>, or
            <code>navigator.sendBeacon</code>. You’ll only find <code>localStorage.getItem</code>/<code>setItem</code> for the theme
            preference and the optional saved inputs toggle.
          </li>
          <li>
            <strong>Browse the GitHub repository.</strong> Inspect the project files directly on <a href="https://github.com/jd-d/zzp-calc" target="_blank" rel="noreferrer noopener">GitHub</a> to confirm exactly what
            the site ships and how it behaves.
          </li>
        </ol>
      </div>
    </section>
  </div>

  <div class="readme-dialog" id="readme-dialog" role="dialog" aria-modal="true" aria-labelledby="readme-title" hidden>
    <div class="readme-dialog__backdrop" id="readme-backdrop" tabindex="-1"></div>
    <div class="readme-dialog__content" role="document">
      <div class="readme-dialog__header">
        <h2 id="readme-title">How To Use This Tool</h2>
        <button type="button" class="readme-dialog__close" id="readme-close" aria-label="Close instructions">×</button>
      </div>
      <div class="readme-dialog__body" id="readme-body" tabindex="0"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    const howToLink = document.getElementById('how-to-link');
    const readmeDialog = document.getElementById('readme-dialog');
    const readmeBody = document.getElementById('readme-body');
    const readmeClose = document.getElementById('readme-close');
    const readmeBackdrop = document.getElementById('readme-backdrop');
    let readmeLoaded = false;
    let readmeLoading = false;
    let previouslyFocusedElement = null;

    const COLLAPSIBLE_SECTION_SELECTOR = '.control-section[data-collapsible]';

    function getSectionLabel(section, index = 0) {
      if (!section) {
        return `Section ${index + 1}`;
      }

      const title = section.querySelector('.section-title');
      const labelText = title && title.textContent ? title.textContent.trim() : '';

      if (labelText) {
        section.dataset.sectionLabel = labelText;
        return labelText;
      }

      if (section.dataset.sectionLabel) {
        return section.dataset.sectionLabel;
      }

      const fallback = `Section ${index + 1}`;
      section.dataset.sectionLabel = fallback;
      return fallback;
    }

    function updateToggleButtonState(toggle, collapsed, sectionLabel) {
      if (!toggle) {
        return;
      }

      const expandedText = toggle.getAttribute('data-expanded-text') || 'Collapse section';
      const collapsedText = toggle.getAttribute('data-collapsed-text') || 'Expand section';
      const labelElement = toggle.querySelector('.toggle-label');
      const nextText = collapsed ? collapsedText : expandedText;

      if (labelElement) {
        labelElement.textContent = nextText;
      } else {
        toggle.textContent = nextText;
      }

      const actionText = collapsed ? collapsedText : expandedText;
      const normalizedAction = actionText.replace(/\s+section$/i, '');
      const normalizedLabel = sectionLabel || 'section';

      toggle.setAttribute('aria-expanded', String(!collapsed));
      toggle.setAttribute('aria-label', `${normalizedAction} ${normalizedLabel} section`);
      toggle.setAttribute('title', `${normalizedAction} ${normalizedLabel} section`);
    }

    const collapsibleSections = new Map();

    function registerCollapsibleSection(section) {
      if (!(section instanceof HTMLElement)) {
        return;
      }

      const body = section.querySelector('.section-body');
      if (!(body instanceof HTMLElement)) {
        return;
      }

      const existing = collapsibleSections.get(section);
      const listeners = existing ? existing.listeners : new Map();
      const collapsed = section.classList.contains('collapsed');
      const fallbackIndex = collapsibleSections.size;
      const sectionLabel = getSectionLabel(section, fallbackIndex);
      section.dataset.sectionLabel = sectionLabel;

      if (!body.id) {
        const baseId = sectionLabel
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '') || `section-${fallbackIndex + 1}`;

        let uniqueId = baseId;
        let attempt = 1;
        while (document.getElementById(uniqueId)) {
          attempt += 1;
          uniqueId = `${baseId}-${attempt}`;
        }

        body.id = uniqueId;
      }

      const seenToggles = new Set();
      section.querySelectorAll('.section-toggle').forEach(toggle => {
        if (!(toggle instanceof HTMLElement)) {
          return;
        }

        seenToggles.add(toggle);

        if (!listeners.has(toggle)) {
          const handler = event => {
            event.preventDefault();
            toggleCollapsibleSection(section, { trigger: toggle });
          };
          toggle.addEventListener('click', handler);
          listeners.set(toggle, handler);
        }

        toggle.setAttribute('aria-controls', body.id);
        updateToggleButtonState(toggle, collapsed, sectionLabel);
      });

      if (existing) {
        for (const [toggle, handler] of listeners) {
          if (!seenToggles.has(toggle)) {
            toggle.removeEventListener('click', handler);
            listeners.delete(toggle);
          }
        }
      }

      collapsibleSections.set(section, { body, listeners });
    }

    function unregisterCollapsibleSection(section) {
      const data = collapsibleSections.get(section);
      if (!data) {
        return;
      }

      for (const [toggle, handler] of data.listeners) {
        toggle.removeEventListener('click', handler);
      }

      collapsibleSections.delete(section);
    }

    function toggleCollapsibleSection(section, { trigger, explicitState } = {}) {
      if (!(section instanceof HTMLElement)) {
        return;
      }

      if (!collapsibleSections.has(section)) {
        registerCollapsibleSection(section);
      }

      const data = collapsibleSections.get(section);
      if (!data) {
        return;
      }

      const isCollapsed = section.classList.contains('collapsed');
      const nextCollapsed = typeof explicitState === 'boolean' ? explicitState : !isCollapsed;

      if (nextCollapsed === isCollapsed) {
        const scroll = () => {
          if (typeof section.scrollIntoView === 'function') {
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        };

        if (typeof requestAnimationFrame === 'function') {
          requestAnimationFrame(scroll);
        } else {
          scroll();
        }
        return;
      }

      section.classList.toggle('collapsed', nextCollapsed);
      const sectionLabel = getSectionLabel(section, 0);
      section.dataset.sectionLabel = sectionLabel;

      for (const toggle of data.listeners.keys()) {
        updateToggleButtonState(toggle, nextCollapsed, sectionLabel);
      }

      if (nextCollapsed && trigger && trigger.classList.contains('section-toggle--bottom')) {
        const topToggle = section.querySelector('.section-toggle--top');
        if (topToggle && typeof topToggle.focus === 'function') {
          try {
            topToggle.focus({ preventScroll: true });
          } catch (error) {
            topToggle.focus();
          }
        }
      }

      const scroll = () => {
        if (typeof section.scrollIntoView === 'function') {
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      };

      if (typeof requestAnimationFrame === 'function') {
        requestAnimationFrame(scroll);
      } else {
        scroll();
      }
    }

    function refreshCollapsibleSections(root = document) {
      Array.from(root.querySelectorAll(COLLAPSIBLE_SECTION_SELECTOR)).forEach(section => {
        registerCollapsibleSection(section);
      });
    }

    refreshCollapsibleSections(document);

    if (typeof MutationObserver === 'function') {
      const observerTarget = document.body || document.documentElement;
      if (observerTarget) {
        const collapsibleObserver = new MutationObserver(mutations => {
          for (const mutation of mutations) {
            mutation.addedNodes?.forEach(node => {
              if (!(node instanceof HTMLElement)) {
                return;
              }

              if (node.matches && node.matches(COLLAPSIBLE_SECTION_SELECTOR)) {
                registerCollapsibleSection(node);
              }

              if (typeof node.querySelectorAll === 'function') {
                node.querySelectorAll(COLLAPSIBLE_SECTION_SELECTOR).forEach(childSection => {
                  registerCollapsibleSection(childSection);
                });
              }
            });

            mutation.removedNodes?.forEach(node => {
              if (!(node instanceof HTMLElement)) {
                return;
              }

              if (collapsibleSections.has(node)) {
                unregisterCollapsibleSection(node);
              }

              if (typeof node.querySelectorAll === 'function') {
                node.querySelectorAll(COLLAPSIBLE_SECTION_SELECTOR).forEach(childSection => {
                  unregisterCollapsibleSection(childSection);
                });
              }
            });
          }
        });

        collapsibleObserver.observe(observerTarget, { childList: true, subtree: true });
      }
    }

    function getFocusableElements(container) {
      if (!container) {
        return [];
      }

      const selectors = [
        'a[href]',
        'button:not([disabled])',
        'textarea:not([disabled])',
        'input:not([disabled])',
        'select:not([disabled])',
        '[tabindex]:not([tabindex="-1"])'
      ].join(',');

      return Array.from(container.querySelectorAll(selectors)).filter(element => {
        if (element.hasAttribute('hidden') || element.getAttribute('aria-hidden') === 'true') {
          return false;
        }
        const rect = element.getBoundingClientRect();
        return rect.width > 0 && rect.height > 0;
      });
    }

    const activeDialogLocks = new Set();

    function setBodyScrollLock(source, locked) {
      if (!source) {
        return;
      }

      if (locked) {
        activeDialogLocks.add(source);
      } else {
        activeDialogLocks.delete(source);
      }

      if (activeDialogLocks.size > 0) {
        document.body.classList.add('dialog-open');
      } else {
        document.body.classList.remove('dialog-open');
      }
    }

    function parseMarkdown(text) {
      if (window.marked && typeof window.marked.parse === 'function') {
        return window.marked.parse(text);
      }
      const escaped = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      return `<pre>${escaped}</pre>`;
    }

    const README_SOURCES = [
      new URL('README.md', document.baseURI).toString(),
      'https://raw.githubusercontent.com/jd-d/zzp-calc/main/README.md'
    ];

    function fetchReadmeFromSources(sources, index = 0) {
      if (!Array.isArray(sources) || index >= sources.length) {
        return Promise.reject(new Error('No README sources available'));
      }

      const source = sources[index];

      return fetch(source)
        .then(response => {
          if (!response || !response.ok) {
            throw new Error(`Failed to load README from ${source} (status ${response ? response.status : 'unknown'})`);
          }
          return response.text();
        })
        .catch(error => {
          if (index < sources.length - 1) {
            if (console && typeof console.warn === 'function') {
              console.warn(error);
            }

            if (readmeBody) {
              readmeBody.innerHTML = '<p class="readme-status">Retrying with a backup instructions source…</p>';
            }

            return fetchReadmeFromSources(sources, index + 1);
          }

          throw error;
        });
    }

    function loadReadme() {
      if (readmeLoaded || readmeLoading || !readmeBody) {
        return;
      }

      readmeLoading = true;

      fetchReadmeFromSources(README_SOURCES)
        .then(text => {
          readmeBody.innerHTML = parseMarkdown(text);
          readmeLoaded = true;
        })
        .catch(() => {
          readmeBody.innerHTML = '<p class="readme-status readme-status--error">Unable to load instructions. Please check the README file directly.</p>';
        })
        .finally(() => {
          readmeLoading = false;
        });
    }

    function openReadme(event) {
      if (event) {
        event.preventDefault();
      }

      if (!readmeDialog || !readmeBody) {
        return;
      }

      previouslyFocusedElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;
      readmeDialog.hidden = false;
      setBodyScrollLock('readme', true);

      if (!readmeLoaded) {
        readmeBody.innerHTML = '<p class="readme-status">Loading instructions…</p>';
        loadReadme();
      }

      window.requestAnimationFrame(() => {
        if (readmeClose) {
          readmeClose.focus();
        }
      });

      document.addEventListener('keydown', handleReadmeKeydown);
    }

    function closeReadme() {
      if (!readmeDialog) {
        return;
      }

      readmeDialog.hidden = true;
      setBodyScrollLock('readme', false);
      document.removeEventListener('keydown', handleReadmeKeydown);

      if (previouslyFocusedElement && typeof previouslyFocusedElement.focus === 'function') {
        previouslyFocusedElement.focus();
      }
    }

    function handleReadmeKeydown(event) {
      if (event.key === 'Escape') {
        closeReadme();
        return;
      }

      if (event.key === 'Tab' && readmeDialog && !readmeDialog.hidden) {
        const focusable = getFocusableElements(readmeDialog);
        if (focusable.length === 0) {
          event.preventDefault();
          return;
        }

        const first = focusable[0];
        const last = focusable[focusable.length - 1];

        if (!event.shiftKey && document.activeElement === last) {
          event.preventDefault();
          first.focus();
        } else if (event.shiftKey && document.activeElement === first) {
          event.preventDefault();
          last.focus();
        }
      }
    }

    if (howToLink) {
      howToLink.addEventListener('click', openReadme);
    }

    if (readmeClose) {
      readmeClose.addEventListener('click', closeReadme);
    }

    if (readmeBackdrop) {
      readmeBackdrop.addEventListener('click', closeReadme);
    }

    if (readmeDialog) {
      readmeDialog.addEventListener('click', event => {
        if (event.target === readmeDialog) {
          closeReadme();
        }
      });
    }

    const themeToggleButton = document.getElementById('theme-toggle');
    const themeToggleLabel = themeToggleButton ? themeToggleButton.querySelector('.toggle-label') : null;
    const THEME_STORAGE_KEY = 'zzp-calc-theme';
    const prefersDarkScheme = typeof window.matchMedia === 'function'
      ? window.matchMedia('(prefers-color-scheme: dark)')
      : { matches: true };

    function getStoredTheme() {
      try {
        const stored = localStorage.getItem(THEME_STORAGE_KEY);
        if (stored === 'light' || stored === 'dark') {
          return stored;
        }
      } catch (error) {
        // Ignore storage access errors (e.g. private browsing restrictions)
      }
      return null;
    }

    function applyThemePreference(theme, { save = true } = {}) {
      const normalized = theme === 'light' ? 'light' : 'dark';
      document.body.dataset.theme = normalized;

      if (save) {
        try {
          localStorage.setItem(THEME_STORAGE_KEY, normalized);
        } catch (error) {
          // Ignore storage access errors
        }
      }

      if (themeToggleButton && themeToggleLabel) {
        const isDark = normalized === 'dark';
        const actionLabel = `Switch to ${isDark ? 'light' : 'dark'} mode`;
        themeToggleButton.setAttribute('aria-pressed', String(isDark));
        themeToggleButton.setAttribute('aria-label', actionLabel);
        themeToggleButton.setAttribute('title', actionLabel);
        themeToggleLabel.textContent = isDark ? 'Dark mode' : 'Light mode';
      }
    }

    const storedTheme = getStoredTheme();
    let respectSystemPreference = !storedTheme;

    applyThemePreference(storedTheme || (prefersDarkScheme.matches ? 'dark' : 'light'), {
      save: Boolean(storedTheme)
    });

    function handlePreferenceChange(event) {
      if (respectSystemPreference) {
        applyThemePreference(event.matches ? 'dark' : 'light', { save: false });
      }
    }

    if (typeof prefersDarkScheme.addEventListener === 'function') {
      prefersDarkScheme.addEventListener('change', handlePreferenceChange);
    } else if (typeof prefersDarkScheme.addListener === 'function') {
      prefersDarkScheme.addListener(handlePreferenceChange);
    }

    if (themeToggleButton) {
      themeToggleButton.addEventListener('click', () => {
        const nextTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
        respectSystemPreference = false;
        applyThemePreference(nextTheme);
      });
    }

    const numberFormatter = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 });

    let latestResults = [];
    let latestCurrencySymbol = '€';
    let latestRevenueSummary = null;
    const PERSISTED_TARGET_NET_BASIS_KEY = '__targetNetBasis';
    const TARGET_NET_BASIS_VALUES = ['year', 'week', 'month', 'avgWeek', 'avgMonth'];
    const TARGET_NET_BASIS_BY_INPUT_ID = {
      'target-net': 'year',
      'target-net-week': 'week',
      'target-net-month': 'month',
      'target-net-average-week': 'avgWeek',
      'target-net-average-month': 'avgMonth'
    };

    const controls = {
      targetNet: document.getElementById('target-net'),
      targetNetWeek: document.getElementById('target-net-week'),
      targetNetMonth: document.getElementById('target-net-month'),
      targetNetAverageWeek: document.getElementById('target-net-average-week'),
      targetNetAverageMonth: document.getElementById('target-net-average-month'),
      taxRate: document.getElementById('tax-rate'),
      fixedCosts: document.getElementById('fixed-costs'),
      variableCostPerClass: document.getElementById('variable-cost-class'),
      vatRate: document.getElementById('vat-rate'),
      monthsOff: document.getElementById('months-off'),
      weeksOffCycle: document.getElementById('weeks-off-cycle'),
      daysOffWeek: document.getElementById('days-off-week'),
      buffer: document.getElementById('buffer'),
      currencySymbol: document.getElementById('currency-symbol'),
      recalcButton: document.getElementById('recalculate'),
      downloadCsv: document.getElementById('download-csv'),
      statusMessage: document.getElementById('status-message'),
      workingWeeksDisplay: document.getElementById('working-weeks-display'),
      workingDaysDisplay: document.getElementById('working-days-display'),
      rememberInputs: document.getElementById('remember-inputs'),
      resetSavedInputs: document.getElementById('reset-saved-inputs')
    };

    const calcState = {
      incomeTargets: {
        basis: 'year',
        year: 0,
        week: 0,
        month: 0,
        averageWeek: 0,
        averageMonth: 0
      },
      capacity: {
        monthsOff: 0,
        weeksOffCycle: 0,
        daysOffWeek: 0
      },
      costs: {
        taxRatePercent: 40,
        fixedCosts: 0,
        variableCostPerClass: 0,
        vatRatePercent: 21,
        bufferPercent: 15
      },
      config: {
        currencySymbol: '€',
        defaults: {
          incomeTargets: {
            year: 0,
            week: 0,
            month: 0,
            averageWeek: 0,
            averageMonth: 0
          }
        }
      }
    };

    function setTargetNetBasis(basis) {
      if (TARGET_NET_BASIS_VALUES.includes(basis)) {
        calcState.incomeTargets.basis = basis;
      }
    }

    function setIncomeTargetValue(key, rawValue) {
      const defaults = calcState.config.defaults.incomeTargets || {};
      const fallback = Number.isFinite(defaults[key]) ? defaults[key] : calcState.incomeTargets[key];
      const normalized = Math.max(parseNumber(rawValue, fallback || 0), 0);
      calcState.incomeTargets[key] = normalized;
    }

    function refreshIncomeTargetDefaultsFromState() {
      const capacityMetrics = computeCapacityMetrics(calcState.capacity);
      const defaults = computeTargetNetDefaults(capacityMetrics);
      calcState.config.defaults.incomeTargets = defaults;
      return capacityMetrics;
    }

    function setMonthsOff(rawValue) {
      const normalized = parseNumber(rawValue, calcState.capacity.monthsOff || 0, { min: 0, max: 12 });
      calcState.capacity.monthsOff = normalized;
      refreshIncomeTargetDefaultsFromState();
    }

    function setWeeksOffCycle(rawValue) {
      const normalized = parseNumber(rawValue, calcState.capacity.weeksOffCycle || 0, { min: 0, max: 4 });
      calcState.capacity.weeksOffCycle = normalized;
      refreshIncomeTargetDefaultsFromState();
    }

    function setDaysOffWeek(rawValue) {
      const normalized = parseNumber(rawValue, calcState.capacity.daysOffWeek || 0, { min: 0, max: BASE_WORK_DAYS_PER_WEEK });
      calcState.capacity.daysOffWeek = normalized;
      refreshIncomeTargetDefaultsFromState();
    }

    function setTaxRatePercent(rawValue) {
      const fallback = Number.isFinite(calcState.costs.taxRatePercent) ? calcState.costs.taxRatePercent : 40;
      const normalized = Math.min(Math.max(parseNumber(rawValue, fallback, { min: 0, max: 99.9 }), 0), 99.9);
      calcState.costs.taxRatePercent = normalized;
    }

    function setVariableCostPerClass(rawValue) {
      const fallback = Number.isFinite(calcState.costs.variableCostPerClass) ? calcState.costs.variableCostPerClass : 0;
      const normalized = Math.max(parseNumber(rawValue, fallback, { min: 0 }), 0);
      calcState.costs.variableCostPerClass = normalized;
    }

    function setVatRatePercent(rawValue) {
      const fallback = Number.isFinite(calcState.costs.vatRatePercent) ? calcState.costs.vatRatePercent : 21;
      const normalized = Math.max(parseNumber(rawValue, fallback, { min: 0 }), 0);
      calcState.costs.vatRatePercent = normalized;
    }

    function setBufferPercent(rawValue) {
      const fallback = Number.isFinite(calcState.costs.bufferPercent) ? calcState.costs.bufferPercent : 15;
      const normalized = Math.max(parseNumber(rawValue, fallback, { min: 0 }), 0);
      calcState.costs.bufferPercent = normalized;
    }

    function setCurrencySymbol(rawValue) {
      const symbol = typeof rawValue === 'string' ? rawValue.trim() : '';
      calcState.config.currencySymbol = symbol || '€';
    }

    function commitControlValueToState(control) {
      if (!(control instanceof HTMLInputElement) || !control.id) {
        return;
      }

      if (TARGET_NET_BASIS_BY_INPUT_ID[control.id]) {
        const keyMap = {
          'target-net': 'year',
          'target-net-week': 'week',
          'target-net-month': 'month',
          'target-net-average-week': 'averageWeek',
          'target-net-average-month': 'averageMonth'
        };
        const key = keyMap[control.id];
        if (key) {
          setIncomeTargetValue(key, control.value);
        }
        return;
      }

      switch (control.id) {
        case 'months-off':
          setMonthsOff(control.value);
          break;
        case 'weeks-off-cycle':
          setWeeksOffCycle(control.value);
          break;
        case 'days-off-week':
          setDaysOffWeek(control.value);
          break;
        case 'tax-rate':
          setTaxRatePercent(control.value);
          break;
        case 'variable-cost-class':
          setVariableCostPerClass(control.value);
          break;
        case 'vat-rate':
          setVatRatePercent(control.value);
          break;
        case 'buffer':
          setBufferPercent(control.value);
          break;
        case 'currency-symbol':
          setCurrencySymbol(control.value);
          break;
        default:
          break;
      }
    }

    const fixedCostFields = {
      location: {
        monthly: document.getElementById('fixed-cost-location-monthly'),
        annual: document.getElementById('fixed-cost-location-annual')
      },
      insurance: {
        monthly: document.getElementById('fixed-cost-insurance-monthly'),
        annual: document.getElementById('fixed-cost-insurance-annual')
      },
      disability: {
        monthly: document.getElementById('fixed-cost-disability-monthly'),
        annual: document.getElementById('fixed-cost-disability-annual')
      },
      health: {
        monthly: document.getElementById('fixed-cost-health-monthly'),
        annual: document.getElementById('fixed-cost-health-annual')
      },
      pension: {
        monthly: document.getElementById('fixed-cost-pension-monthly'),
        annual: document.getElementById('fixed-cost-pension-annual')
      },
      marketing: {
        monthly: document.getElementById('fixed-cost-marketing-monthly'),
        annual: document.getElementById('fixed-cost-marketing-annual')
      },
      materials: {
        monthly: document.getElementById('fixed-cost-materials-monthly'),
        annual: document.getElementById('fixed-cost-materials-annual')
      },
      admin: {
        monthly: document.getElementById('fixed-cost-admin-monthly'),
        annual: document.getElementById('fixed-cost-admin-annual')
      },
      development: {
        monthly: document.getElementById('fixed-cost-development-monthly'),
        annual: document.getElementById('fixed-cost-development-annual')
      }
    };

    controls.fixedCostFields = fixedCostFields;

    const rememberInputsToggle = controls.rememberInputs instanceof HTMLInputElement ? controls.rememberInputs : null;
    const resetSavedInputsButton = controls.resetSavedInputs instanceof HTMLButtonElement ? controls.resetSavedInputs : null;
    const PERSISTENCE_ENABLED_KEY = 'zzp-calc-save-enabled';
    const PERSISTENCE_VALUES_KEY = 'zzp-calc-saved-inputs';
    let persistenceEnabled = false;
    let persistableInputsCache = null;

    function getPersistableInputs() {
      if (persistableInputsCache) {
        return persistableInputsCache;
      }
      const container = document.querySelector('.card.controls');
      if (!(container instanceof HTMLElement)) {
        persistableInputsCache = [];
        return persistableInputsCache;
      }
      persistableInputsCache = Array.from(container.querySelectorAll('input')).filter(input => {
        return input instanceof HTMLInputElement && input.type !== 'button' && input.id !== 'remember-inputs';
      });
      return persistableInputsCache;
    }

    function captureInputValues(inputs = getPersistableInputs()) {
      const values = inputs.reduce((accumulator, input) => {
        if (!(input instanceof HTMLInputElement) || !input.id) {
          return accumulator;
        }
        if (input.type === 'checkbox' || input.type === 'radio') {
          accumulator[input.id] = input.checked;
        } else {
          accumulator[input.id] = input.value;
        }
        return accumulator;
      }, {});
      values[PERSISTED_TARGET_NET_BASIS_KEY] = calcState.incomeTargets.basis;
      return values;
    }

    function initializeCalcStateFromControls() {
      const views = updateCalcStateFromControls();
      applyCalcStateToControls(views);
      return views;
    }

    function applyCalcStateToControls(views = {}) {
      const { capacity = {}, income = {}, costs = {} } = views;
      const basis = income.basis || calcState.incomeTargets.basis;

      if (controls.targetNet instanceof HTMLInputElement) {
        const yearValue = Number.isFinite(income.targetNet) ? income.targetNet : calcState.incomeTargets.year;
        controls.targetNet.value = formatFixed(Math.max(yearValue || 0, 0), 2);
      }

      if (controls.targetNetWeek instanceof HTMLInputElement) {
        const weekDisplayValue = basis === 'week' ? calcState.incomeTargets.week : income.targetNetPerWeek;
        controls.targetNetWeek.value = weekDisplayValue == null || !Number.isFinite(weekDisplayValue)
          ? ''
          : formatFixed(weekDisplayValue, 2);
      }

      if (controls.targetNetMonth instanceof HTMLInputElement) {
        const monthDisplayValue = basis === 'month' ? calcState.incomeTargets.month : income.targetNetPerMonth;
        controls.targetNetMonth.value = monthDisplayValue == null || !Number.isFinite(monthDisplayValue)
          ? ''
          : formatFixed(monthDisplayValue, 2);
      }

      if (controls.targetNetAverageWeek instanceof HTMLInputElement) {
        const averageWeekDisplayValue = basis === 'avgWeek'
          ? calcState.incomeTargets.averageWeek
          : income.targetNetAveragePerWeek;
        controls.targetNetAverageWeek.value = averageWeekDisplayValue == null || !Number.isFinite(averageWeekDisplayValue)
          ? ''
          : formatFixed(averageWeekDisplayValue, 2);
      }

      if (controls.targetNetAverageMonth instanceof HTMLInputElement) {
        const averageMonthDisplayValue = basis === 'avgMonth'
          ? calcState.incomeTargets.averageMonth
          : income.targetNetAveragePerMonth;
        controls.targetNetAverageMonth.value = averageMonthDisplayValue == null || !Number.isFinite(averageMonthDisplayValue)
          ? ''
          : formatFixed(averageMonthDisplayValue, 2);
      }

      if (controls.taxRate instanceof HTMLInputElement) {
        controls.taxRate.value = formatFixed(calcState.costs.taxRatePercent, 1);
      }

      if (controls.fixedCosts instanceof HTMLInputElement) {
        const fixedCostsValue = Number.isFinite(costs.fixedCosts) ? costs.fixedCosts : calcState.costs.fixedCosts;
        controls.fixedCosts.value = formatFixed(Math.max(fixedCostsValue || 0, 0), 2);
      }

      if (controls.variableCostPerClass instanceof HTMLInputElement) {
        controls.variableCostPerClass.value = formatFixed(calcState.costs.variableCostPerClass, 2);
      }

      if (controls.vatRate instanceof HTMLInputElement) {
        controls.vatRate.value = formatFixed(calcState.costs.vatRatePercent, 1);
      }

      if (controls.monthsOff instanceof HTMLInputElement) {
        controls.monthsOff.value = formatFixed(calcState.capacity.monthsOff, 2);
      }

      if (controls.weeksOffCycle instanceof HTMLInputElement) {
        controls.weeksOffCycle.value = formatFixed(calcState.capacity.weeksOffCycle, 2);
      }

      if (controls.daysOffWeek instanceof HTMLInputElement) {
        controls.daysOffWeek.value = formatFixed(calcState.capacity.daysOffWeek, 2);
      }

      if (controls.buffer instanceof HTMLInputElement) {
        controls.buffer.value = formatFixed(calcState.costs.bufferPercent, 1);
      }

      if (controls.currencySymbol instanceof HTMLInputElement) {
        controls.currencySymbol.value = calcState.config.currencySymbol || '€';
      }

      if (controls.workingWeeksDisplay) {
        const value = Number.isFinite(capacity.workingWeeks) ? capacity.workingWeeks : 0;
        controls.workingWeeksDisplay.textContent = formatFixed(value, 2);
      }

      if (controls.workingDaysDisplay) {
        const value = Number.isFinite(capacity.workingDaysPerYear) ? capacity.workingDaysPerYear : 0;
        controls.workingDaysDisplay.textContent = formatFixed(value, 2);
      }
    }

    const defaultInputValues = captureInputValues();

    function readPersistenceEnabled() {
      try {
        return localStorage.getItem(PERSISTENCE_ENABLED_KEY) === 'true';
      } catch (error) {
        return false;
      }
    }

    function readPersistedValues() {
      try {
        const raw = localStorage.getItem(PERSISTENCE_VALUES_KEY);
        if (!raw) {
          return null;
        }
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === 'object') {
          return parsed;
        }
      } catch (error) {
        // Ignore parsing errors
      }
      return null;
    }

    function clearPersistedInputs() {
      try {
        localStorage.removeItem(PERSISTENCE_VALUES_KEY);
        localStorage.removeItem(PERSISTENCE_ENABLED_KEY);
      } catch (error) {
        // Ignore storage errors
      }
    }

    function applyInputValues(values, options = {}) {
      const { skipRender = false } = options;
      if (!values || typeof values !== 'object') {
        return;
      }
      const storedBasis = values[PERSISTED_TARGET_NET_BASIS_KEY];
      if (typeof storedBasis === 'string' && TARGET_NET_BASIS_VALUES.includes(storedBasis)) {
        setTargetNetBasis(storedBasis);
      }
      const inputs = getPersistableInputs();
      inputs.forEach(input => {
        if (!(input instanceof HTMLInputElement) || !input.id) {
          return;
        }
        if (!Object.prototype.hasOwnProperty.call(values, input.id)) {
          return;
        }
        const storedValue = values[input.id];
        if (input.type === 'checkbox' || input.type === 'radio') {
          input.checked = Boolean(storedValue);
        } else {
          input.value = storedValue === null || typeof storedValue === 'undefined'
            ? ''
            : String(storedValue);
        }
      });
      initializeCalcStateFromControls();
      if (!skipRender) {
        render();
      }
    }

    function savePersistedInputs() {
      if (!persistenceEnabled) {
        return;
      }
      try {
        const values = captureInputValues();
        localStorage.setItem(PERSISTENCE_VALUES_KEY, JSON.stringify(values));
        localStorage.setItem(PERSISTENCE_ENABLED_KEY, 'true');
      } catch (error) {
        persistenceEnabled = false;
        if (rememberInputsToggle) {
          rememberInputsToggle.checked = false;
        }
      }
    }

    function handlePersistableInputMutation(event) {
      if (event && event.target instanceof HTMLInputElement) {
        const nextBasis = TARGET_NET_BASIS_BY_INPUT_ID[event.target.id];
        if (typeof nextBasis === 'string') {
          setTargetNetBasis(nextBasis);
        }
        commitControlValueToState(event.target);
      }
      if (persistenceEnabled) {
        savePersistedInputs();
      }
    }

    function initializePersistence() {
      if (rememberInputsToggle) {
        rememberInputsToggle.checked = readPersistenceEnabled();
        persistenceEnabled = rememberInputsToggle.checked;
      } else {
        persistenceEnabled = false;
      }

      const storedValues = persistenceEnabled ? readPersistedValues() : null;
      if (storedValues) {
        applyInputValues(storedValues, { skipRender: true });
      }

      getPersistableInputs().forEach(input => {
        input.addEventListener('input', handlePersistableInputMutation);
        input.addEventListener('change', handlePersistableInputMutation);
      });

      if (rememberInputsToggle) {
        rememberInputsToggle.addEventListener('change', () => {
          persistenceEnabled = rememberInputsToggle.checked;
          if (persistenceEnabled) {
            savePersistedInputs();
          } else {
            clearPersistedInputs();
          }
        });
      }

      if (resetSavedInputsButton) {
        resetSavedInputsButton.addEventListener('click', () => {
          applyInputValues(defaultInputValues);
          if (persistenceEnabled) {
            savePersistedInputs();
          } else {
            clearPersistedInputs();
          }
        });
      }
    }

    const tablesContainer = document.getElementById('tables-container');
    let tablesLayoutUpdateScheduled = false;
    const assumptionsList = document.getElementById('assumptions-list');

    const INFO_ICON_ACTIVE_CLASS = 'is-active';
    const TOOLTIP_VIEWPORT_PADDING = 16;
    let activeInfoIcon = null;
    let infoIconTooltipId = 0;

    function isInfoIcon(element) {
      return element instanceof HTMLElement && element.classList.contains('info-icon');
    }

    function ensureInfoIconTooltip(icon) {
      if (!isInfoIcon(icon)) {
        return null;
      }
      let tooltip = icon.querySelector('.info-icon__tooltip');
      if (!(tooltip instanceof HTMLElement)) {
        tooltip = document.createElement('span');
        tooltip.className = 'info-icon__tooltip';
        tooltip.setAttribute('role', 'tooltip');
        icon.append(tooltip);
      }
      let arrow = icon.querySelector('.info-icon__arrow');
      if (!(arrow instanceof HTMLElement)) {
        arrow = document.createElement('span');
        arrow.className = 'info-icon__arrow';
        arrow.setAttribute('aria-hidden', 'true');
        icon.append(arrow);
      }
      const tooltipText = icon.dataset.tooltip || icon.getAttribute('aria-label') || '';
      tooltip.textContent = tooltipText;
      if (!tooltip.id) {
        infoIconTooltipId += 1;
        tooltip.id = `info-icon-tooltip-${infoIconTooltipId}`;
      }
      if (!icon.hasAttribute('aria-describedby')) {
        icon.setAttribute('aria-describedby', tooltip.id);
      }
      return { tooltip, arrow };
    }

    function positionInfoIconTooltip(icon) {
      if (!isInfoIcon(icon)) {
        return;
      }
      const parts = ensureInfoIconTooltip(icon);
      if (!parts || !(parts.tooltip instanceof HTMLElement)) {
        return;
      }
      icon.style.setProperty('--tooltip-shift', '0px');
      const tooltipRect = parts.tooltip.getBoundingClientRect();
      const viewportWidth = window.innerWidth || document.documentElement.clientWidth || 0;
      const padding = TOOLTIP_VIEWPORT_PADDING;
      let shift = 0;
      if (tooltipRect.left < padding) {
        shift = padding - tooltipRect.left;
      } else if (tooltipRect.right > viewportWidth - padding) {
        shift = -(tooltipRect.right - (viewportWidth - padding));
      }
      icon.style.setProperty('--tooltip-shift', `${shift}px`);
    }

    function enhanceInfoIcon(icon) {
      if (!isInfoIcon(icon)) {
        return;
      }
      if (!icon.hasAttribute('tabindex')) {
        icon.setAttribute('tabindex', '0');
      }
      icon.setAttribute('role', 'button');
      icon.setAttribute('aria-expanded', icon.classList.contains(INFO_ICON_ACTIVE_CLASS) ? 'true' : 'false');
      if (!icon.hasAttribute('aria-label') && icon.dataset.tooltip) {
        icon.setAttribute('aria-label', icon.dataset.tooltip);
      }
      ensureInfoIconTooltip(icon);
    }

    function enhanceAllInfoIcons() {
      document.querySelectorAll('.info-icon').forEach(enhanceInfoIcon);
    }

    function closeActiveInfoIcon() {
      if (activeInfoIcon instanceof HTMLElement) {
        activeInfoIcon.classList.remove(INFO_ICON_ACTIVE_CLASS);
        activeInfoIcon.setAttribute('aria-expanded', 'false');
      }
      activeInfoIcon = null;
    }

    function openInfoIcon(icon) {
      if (!isInfoIcon(icon)) {
        return;
      }
      if (activeInfoIcon && activeInfoIcon !== icon) {
        closeActiveInfoIcon();
      }
      icon.classList.add(INFO_ICON_ACTIVE_CLASS);
      icon.setAttribute('aria-expanded', 'true');
      activeInfoIcon = icon;
      positionInfoIconTooltip(icon);
    }

    function toggleInfoIcon(icon) {
      if (!isInfoIcon(icon)) {
        return;
      }
      if (icon.classList.contains(INFO_ICON_ACTIVE_CLASS)) {
        if (activeInfoIcon === icon) {
          closeActiveInfoIcon();
        } else {
          icon.classList.remove(INFO_ICON_ACTIVE_CLASS);
          icon.setAttribute('aria-expanded', 'false');
        }
      } else {
        openInfoIcon(icon);
      }
    }

    document.addEventListener('click', event => {
      const target = event.target instanceof HTMLElement ? event.target.closest('.info-icon') : null;
      if (!isInfoIcon(target)) {
        closeActiveInfoIcon();
        return;
      }
      event.preventDefault();
      enhanceInfoIcon(target);
      toggleInfoIcon(target);
      positionInfoIconTooltip(target);
      if (typeof target.focus === 'function') {
        target.focus();
      }
    });

    document.addEventListener('keydown', event => {
      if (event.key === 'Escape') {
        if (activeInfoIcon) {
          event.preventDefault();
          const current = activeInfoIcon;
          closeActiveInfoIcon();
          if (current instanceof HTMLElement && typeof current.focus === 'function') {
            current.focus();
          }
        }
        return;
      }

      const target = event.target instanceof HTMLElement ? event.target.closest('.info-icon') : null;
      if (!isInfoIcon(target)) {
        return;
      }

      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        enhanceInfoIcon(target);
        toggleInfoIcon(target);
        positionInfoIconTooltip(target);
      }
    });

    document.addEventListener('focusin', event => {
      const target = event.target instanceof HTMLElement ? event.target.closest('.info-icon') : null;
      if (!isInfoIcon(target)) {
        closeActiveInfoIcon();
        return;
      }
      enhanceInfoIcon(target);
      positionInfoIconTooltip(target);
    });

    enhanceAllInfoIcons();

    document.addEventListener('mouseover', event => {
      const target = event.target instanceof HTMLElement ? event.target.closest('.info-icon') : null;
      if (!isInfoIcon(target)) {
        return;
      }
      positionInfoIconTooltip(target);
    });

    window.addEventListener('resize', () => {
      if (activeInfoIcon) {
        positionInfoIconTooltip(activeInfoIcon);
      }
    });

    const WEEKS_PER_YEAR = 52;
    const MONTHS_PER_YEAR = 12;
    const BASE_WORK_DAYS_PER_WEEK = 7;
    const TARGET_NET_DEFAULT = 50000;

    function formatFixed(value, fractionDigits = 1) {
      const fixed = value.toFixed(fractionDigits);
      return fixed
        .replace(/\.0+$/, '')
        .replace(/(\.[0-9]*[1-9])0+$/, '$1');
    }

    function parseNumber(value, fallback = 0, { min = -Infinity, max = Infinity } = {}) {
      if (value === null || value === undefined) {
        return fallback;
      }
      const normalized = typeof value === 'string' ? value.trim() : value;
      if (normalized === '') {
        return fallback;
      }
      const parsed = Number(normalized);
      if (!Number.isFinite(parsed)) {
        return fallback;
      }
      return Math.min(Math.max(parsed, min), max);
    }

    function parseList(value) {
      if (!value) {
        return [];
      }

      const values = [];
      const tokens = value
        .split(',')
        .map(token => token.trim())
        .filter(token => token.length > 0);

      tokens.forEach(token => {
        const rangeMatch = token.match(/^(-?\d+(?:\.\d+)?)\s*-\s*(-?\d+(?:\.\d+)?)$/);
        if (rangeMatch) {
          const startValue = Math.round(Number(rangeMatch[1]));
          const endValue = Math.round(Number(rangeMatch[2]));
          if (!Number.isFinite(startValue) || !Number.isFinite(endValue)) {
            return;
          }

          const rangeStart = Math.min(startValue, endValue);
          const rangeEnd = Math.max(startValue, endValue);
          for (let current = rangeStart; current <= rangeEnd; current += 1) {
            if (current > 0) {
              values.push(current);
            }
          }
          return;
        }

        const parsed = Math.round(Number(token));
        if (Number.isFinite(parsed) && parsed > 0) {
          values.push(parsed);
        }
      });

      return Array.from(new Set(values)).sort((a, b) => a - b);
    }

    function updateTablesLayout() {
      if (!tablesContainer) {
        return;
      }

      const cards = tablesContainer.querySelectorAll('.card');
      if (cards.length <= 1) {
        tablesContainer.classList.remove('table-grid--stacked');
        return;
      }

      const hasOverflow = tablesContainer.scrollWidth > tablesContainer.clientWidth + 1;
      tablesContainer.classList.toggle('table-grid--stacked', hasOverflow);
    }

    function scheduleTablesLayoutUpdate() {
      if (!tablesContainer) {
        return;
      }
      if (tablesLayoutUpdateScheduled) {
        return;
      }

      tablesLayoutUpdateScheduled = true;
      requestAnimationFrame(() => {
        tablesLayoutUpdateScheduled = false;
        updateTablesLayout();
      });
    }

    function getFixedCostTotal() {
      return Object.values(fixedCostFields).reduce((sum, fieldSet) => {
        if (!(fieldSet.annual instanceof HTMLInputElement)) {
          return sum;
        }
        const annualValue = Math.max(parseNumber(fieldSet.annual.value, 0), 0);
        return sum + annualValue;
      }, 0);
    }

    function updateFixedCostTotalDisplay() {
      const total = getFixedCostTotal();
      const normalized = Math.max(total, 0);
      calcState.costs.fixedCosts = normalized;
      if (controls.fixedCosts instanceof HTMLInputElement) {
        controls.fixedCosts.value = formatFixed(normalized, 2);
      }
      return normalized;
    }

    function syncFixedCostPair(key, sourceType) {
      const fieldSet = fixedCostFields[key];
      if (!fieldSet) {
        return;
      }
      const source = sourceType === 'monthly' ? fieldSet.monthly : fieldSet.annual;
      const target = sourceType === 'monthly' ? fieldSet.annual : fieldSet.monthly;
      if (!(source instanceof HTMLInputElement) || !(target instanceof HTMLInputElement)) {
        return;
      }

      if (source.value === '') {
        target.value = '';
        updateFixedCostTotalDisplay();
        return;
      }

      const parsed = Math.max(parseNumber(source.value, 0), 0);
      const derived = sourceType === 'monthly' ? parsed * 12 : parsed / 12;

      if (Number.isFinite(derived)) {
        target.value = formatFixed(derived, 2);
      }

      updateFixedCostTotalDisplay();
    }

    Object.entries(fixedCostFields).forEach(([key, fieldSet]) => {
      const { monthly, annual } = fieldSet;
      if (monthly instanceof HTMLInputElement) {
        monthly.addEventListener('input', () => {
          syncFixedCostPair(key, 'monthly');
          render();
        });
        monthly.addEventListener('change', () => {
          syncFixedCostPair(key, 'monthly');
          if (monthly.value !== '') {
            const normalized = Math.max(parseNumber(monthly.value, 0), 0);
            monthly.value = formatFixed(normalized, 2);
          }
          render();
        });
      }
      if (annual instanceof HTMLInputElement) {
        annual.addEventListener('input', () => {
          syncFixedCostPair(key, 'annual');
          render();
        });
        annual.addEventListener('change', () => {
          syncFixedCostPair(key, 'annual');
          if (annual.value !== '') {
            const normalized = Math.max(parseNumber(annual.value, 0), 0);
            annual.value = formatFixed(normalized, 2);
          }
          render();
        });
      }
    });

    function computeCapacityMetrics(capacityState) {
      const monthsOff = Math.min(Math.max(Number(capacityState.monthsOff) || 0, 0), 12);
      const weeksOffPerCycle = Math.min(Math.max(Number(capacityState.weeksOffCycle) || 0, 0), 4);
      const daysOffPerWeek = Math.min(
        Math.max(Number(capacityState.daysOffWeek) || 0, 0),
        BASE_WORK_DAYS_PER_WEEK
      );
      const activeMonthShare = Math.min(Math.max((MONTHS_PER_YEAR - monthsOff) / MONTHS_PER_YEAR, 0), 1);
      const activeMonths = MONTHS_PER_YEAR * activeMonthShare;
      const weeksShare = Math.min(Math.max((4 - weeksOffPerCycle) / 4, 0), 1);
      const workingWeeks = WEEKS_PER_YEAR * activeMonthShare * weeksShare;
      const workingDaysPerWeek = Math.max(
        0,
        Math.min(BASE_WORK_DAYS_PER_WEEK, BASE_WORK_DAYS_PER_WEEK - daysOffPerWeek)
      );
      const workingDaysPerYear = workingWeeks * workingDaysPerWeek;

      return {
        monthsOff,
        weeksOffPerCycle,
        daysOffPerWeek,
        activeMonthShare,
        activeMonths,
        weeksShare,
        workingWeeks,
        workingDaysPerWeek,
        workingDaysPerYear
      };
    }

    function computeTargetNetDefaults(capacityMetrics) {
      const { workingWeeks, activeMonths } = capacityMetrics;
      return {
        year: TARGET_NET_DEFAULT,
        week: workingWeeks > 0 ? TARGET_NET_DEFAULT / workingWeeks : TARGET_NET_DEFAULT,
        month: activeMonths > 0 ? TARGET_NET_DEFAULT / activeMonths : TARGET_NET_DEFAULT,
        averageWeek: TARGET_NET_DEFAULT / WEEKS_PER_YEAR,
        averageMonth: TARGET_NET_DEFAULT / MONTHS_PER_YEAR
      };
    }

    function computeIncomeTargets(state, capacityMetrics) {
      const defaults = state.config.defaults.incomeTargets || computeTargetNetDefaults(capacityMetrics);
      const basis = TARGET_NET_BASIS_VALUES.includes(state.incomeTargets.basis)
        ? state.incomeTargets.basis
        : 'year';
      const year = Math.max(state.incomeTargets.year, 0);
      const week = Math.max(state.incomeTargets.week, 0);
      const month = Math.max(state.incomeTargets.month, 0);
      const averageWeek = Math.max(state.incomeTargets.averageWeek, 0);
      const averageMonth = Math.max(state.incomeTargets.averageMonth, 0);

      let targetNet = year;
      if (basis === 'week') {
        targetNet = capacityMetrics.workingWeeks > 0 ? week * capacityMetrics.workingWeeks : year;
      } else if (basis === 'month') {
        targetNet = capacityMetrics.activeMonths > 0 ? month * capacityMetrics.activeMonths : year;
      } else if (basis === 'avgWeek') {
        targetNet = averageWeek * WEEKS_PER_YEAR;
      } else if (basis === 'avgMonth') {
        targetNet = averageMonth * MONTHS_PER_YEAR;
      }

      targetNet = Math.max(targetNet, 0);

      const hasWorkingWeeks = capacityMetrics.workingWeeks > 0;
      const hasActiveMonths = capacityMetrics.activeMonths > 0;

      return {
        basis,
        year,
        week,
        month,
        averageWeek,
        averageMonth,
        targetNet,
        targetNetPerWeek: hasWorkingWeeks ? targetNet / capacityMetrics.workingWeeks : null,
        targetNetPerMonth: hasActiveMonths ? targetNet / capacityMetrics.activeMonths : null,
        targetNetAveragePerWeek: targetNet / WEEKS_PER_YEAR,
        targetNetAveragePerMonth: targetNet / MONTHS_PER_YEAR,
        hasWorkingWeeks,
        hasActiveMonths,
        defaults
      };
    }

    function computeCostMetrics(state, capacityMetrics) {
      const taxRatePercent = Math.min(Math.max(state.costs.taxRatePercent, 0), 99.9);
      const taxRate = taxRatePercent / 100;
      const fixedCosts = Math.max(state.costs.fixedCosts, 0);
      const variableCostPerClass = Math.max(state.costs.variableCostPerClass, 0);
      const vatRatePercent = Math.max(state.costs.vatRatePercent, 0);
      const vatRate = vatRatePercent / 100;
      const bufferPercent = Math.max(state.costs.bufferPercent, 0);
      const buffer = bufferPercent / 100;
      const workingDaysPerYear = Number.isFinite(capacityMetrics.workingDaysPerYear)
        ? capacityMetrics.workingDaysPerYear
        : 0;
      const annualVariableCosts = variableCostPerClass * workingDaysPerYear;
      const currencySymbol = state.config.currencySymbol || '€';

      return {
        taxRate,
        taxRatePercent,
        fixedCosts,
        variableCostPerClass,
        vatRate,
        vatRatePercent,
        buffer,
        bufferPercent,
        annualVariableCosts,
        currencySymbol
      };
    }

    function deriveCalcViews(capacityMetrics, defaults) {
      const capacity = capacityMetrics || computeCapacityMetrics(calcState.capacity);
      const incomeDefaults = defaults || computeTargetNetDefaults(capacity);
      calcState.config.defaults.incomeTargets = incomeDefaults;
      const income = computeIncomeTargets(calcState, capacity);
      const costs = computeCostMetrics(calcState, capacity);
      return { capacity, defaults: incomeDefaults, income, costs };
    }

    function updateCalcStateFromControls() {
      const monthsOffRaw = controls.monthsOff instanceof HTMLInputElement
        ? controls.monthsOff.value
        : calcState.capacity.monthsOff;
      const weeksOffRaw = controls.weeksOffCycle instanceof HTMLInputElement
        ? controls.weeksOffCycle.value
        : calcState.capacity.weeksOffCycle;
      const daysOffRaw = controls.daysOffWeek instanceof HTMLInputElement
        ? controls.daysOffWeek.value
        : calcState.capacity.daysOffWeek;

      calcState.capacity.monthsOff = parseNumber(monthsOffRaw, calcState.capacity.monthsOff || 0, {
        min: 0,
        max: 12
      });
      calcState.capacity.weeksOffCycle = parseNumber(weeksOffRaw, calcState.capacity.weeksOffCycle || 0, {
        min: 0,
        max: 4
      });
      calcState.capacity.daysOffWeek = parseNumber(daysOffRaw, calcState.capacity.daysOffWeek || 0, {
        min: 0,
        max: BASE_WORK_DAYS_PER_WEEK
      });

      const capacityMetrics = computeCapacityMetrics(calcState.capacity);
      const defaults = computeTargetNetDefaults(capacityMetrics);
      calcState.config.defaults.incomeTargets = defaults;

      const yearRaw = controls.targetNet instanceof HTMLInputElement
        ? controls.targetNet.value
        : calcState.incomeTargets.year;
      const weekRaw = controls.targetNetWeek instanceof HTMLInputElement
        ? controls.targetNetWeek.value
        : calcState.incomeTargets.week;
      const monthRaw = controls.targetNetMonth instanceof HTMLInputElement
        ? controls.targetNetMonth.value
        : calcState.incomeTargets.month;
      const averageWeekRaw = controls.targetNetAverageWeek instanceof HTMLInputElement
        ? controls.targetNetAverageWeek.value
        : calcState.incomeTargets.averageWeek;
      const averageMonthRaw = controls.targetNetAverageMonth instanceof HTMLInputElement
        ? controls.targetNetAverageMonth.value
        : calcState.incomeTargets.averageMonth;

      calcState.incomeTargets.year = Math.max(parseNumber(yearRaw, defaults.year), 0);
      calcState.incomeTargets.week = Math.max(parseNumber(weekRaw, defaults.week), 0);
      calcState.incomeTargets.month = Math.max(parseNumber(monthRaw, defaults.month), 0);
      calcState.incomeTargets.averageWeek = Math.max(parseNumber(averageWeekRaw, defaults.averageWeek), 0);
      calcState.incomeTargets.averageMonth = Math.max(parseNumber(averageMonthRaw, defaults.averageMonth), 0);

      if (!TARGET_NET_BASIS_VALUES.includes(calcState.incomeTargets.basis)) {
        calcState.incomeTargets.basis = 'year';
      }

      const taxRateRaw = controls.taxRate instanceof HTMLInputElement
        ? controls.taxRate.value
        : calcState.costs.taxRatePercent;
      const variableCostRaw = controls.variableCostPerClass instanceof HTMLInputElement
        ? controls.variableCostPerClass.value
        : calcState.costs.variableCostPerClass;
      const vatRateRaw = controls.vatRate instanceof HTMLInputElement
        ? controls.vatRate.value
        : calcState.costs.vatRatePercent;
      const bufferRaw = controls.buffer instanceof HTMLInputElement
        ? controls.buffer.value
        : calcState.costs.bufferPercent;
      const currencySymbolRaw = controls.currencySymbol instanceof HTMLInputElement
        ? controls.currencySymbol.value
        : calcState.config.currencySymbol;

      calcState.costs.taxRatePercent = Math.min(
        Math.max(parseNumber(taxRateRaw, calcState.costs.taxRatePercent ?? 40), 0),
        99.9
      );
      calcState.costs.variableCostPerClass = Math.max(
        parseNumber(variableCostRaw, calcState.costs.variableCostPerClass ?? 0),
        0
      );
      calcState.costs.vatRatePercent = Math.max(
        parseNumber(vatRateRaw, calcState.costs.vatRatePercent ?? 21),
        0
      );
      calcState.costs.bufferPercent = Math.max(
        parseNumber(bufferRaw, calcState.costs.bufferPercent ?? 15),
        0
      );
      calcState.config.currencySymbol = typeof currencySymbolRaw === 'string' && currencySymbolRaw.trim()
        ? currencySymbolRaw.trim()
        : '€';

      const fixedCosts = getFixedCostTotal();
      calcState.costs.fixedCosts = Math.max(fixedCosts, 0);

      return deriveCalcViews(capacityMetrics, defaults);
    }

    function getInputs() {
      const views = updateCalcStateFromControls();
      applyCalcStateToControls(views);

      const { capacity, income, costs } = views;

      return {
        targetNet: income.targetNet,
        targetNetPerWeek: income.targetNetPerWeek,
        targetNetPerMonth: income.targetNetPerMonth,
        targetNetAveragePerWeek: income.targetNetAveragePerWeek,
        targetNetAveragePerMonth: income.targetNetAveragePerMonth,
        taxRate: costs.taxRate,
        fixedCosts: costs.fixedCosts,
        variableCostPerClass: costs.variableCostPerClass,
        vatRate: costs.vatRate,
        annualVariableCosts: costs.annualVariableCosts,
        workingWeeks: capacity.workingWeeks,
        buffer: costs.buffer,
        bufferPercent: costs.bufferPercent,
        currencySymbol: costs.currencySymbol,
        monthsOff: capacity.monthsOff,
        weeksOffPerCycle: capacity.weeksOffPerCycle,
        daysOffPerWeek: capacity.daysOffPerWeek,
        workingDaysPerWeek: capacity.workingDaysPerWeek,
        workingDaysPerYear: capacity.workingDaysPerYear,
        activeMonths: capacity.activeMonths,
        activeMonthShare: capacity.activeMonthShare,
        weeksShare: capacity.weeksShare
      };
    }

    function formatCurrency(symbol, value) {
      if (!Number.isFinite(value)) {
        return `${symbol}0`;
      }
      const rounded = Math.round(value);
      const formatted = numberFormatter.format(Math.abs(rounded));
      return rounded < 0 ? `-${symbol}${formatted}` : `${symbol}${formatted}`;
    }


    function computeRevenueSummary(inputs) {
      const {
        targetNet,
        taxRate,
        fixedCosts,
        annualVariableCosts,
        buffer,
        bufferPercent,
        workingWeeks,
        activeMonths,
        workingDaysPerYear
      } = inputs;

      const effectiveTaxRate = Math.min(Math.max(taxRate, 0), 0.99);
      const denominator = Math.max(1 - effectiveTaxRate, 0.0001);
      const profitBeforeTax = targetNet / denominator;
      const baseRevenue = profitBeforeTax + fixedCosts + annualVariableCosts;
      const bufferedRevenue = baseRevenue * (1 + buffer);

      const monthlyBase = Number.isFinite(activeMonths) && activeMonths > 0 ? baseRevenue / activeMonths : null;
      const monthlyBuffered = Number.isFinite(activeMonths) && activeMonths > 0 ? bufferedRevenue / activeMonths : null;
      const weeklyBase = Number.isFinite(workingWeeks) && workingWeeks > 0 ? baseRevenue / workingWeeks : null;
      const weeklyBuffered = Number.isFinite(workingWeeks) && workingWeeks > 0 ? bufferedRevenue / workingWeeks : null;
      const dailyBase = Number.isFinite(workingDaysPerYear) && workingDaysPerYear > 0
        ? baseRevenue / workingDaysPerYear
        : null;
      const dailyBuffered = Number.isFinite(workingDaysPerYear) && workingDaysPerYear > 0
        ? bufferedRevenue / workingDaysPerYear
        : null;

      return {
        baseRevenue,
        bufferedRevenue,
        bufferPercent,
        monthlyBase,
        monthlyBuffered,
        weeklyBase,
        weeklyBuffered,
        dailyBase,
        dailyBuffered
      };
    }

    function buildRevenueSummaryTable(summary, currencySymbol, inputs) {
      if (!summary || !Number.isFinite(summary.baseRevenue)) {
        return `
        <div class="card">
          <p class="status-message">Enter your income targets and costs to see the revenue summary.</p>
        </div>
        `;
      }

      const rows = [
        {
          label: 'Annual total',
          base: summary.baseRevenue,
          buffered: summary.bufferedRevenue,
          basis: 'Includes fixed costs and estimated variable costs before applying the safety margin.'
        },
        {
          label: 'Active month',
          base: summary.monthlyBase,
          buffered: summary.monthlyBuffered,
          basis: Number.isFinite(inputs.activeMonths) && inputs.activeMonths > 0
            ? `Based on ≈ ${formatFixed(inputs.activeMonths, 2)} active months / year`
            : '—'
        },
        {
          label: 'Active week',
          base: summary.weeklyBase,
          buffered: summary.weeklyBuffered,
          basis: Number.isFinite(inputs.workingWeeks) && inputs.workingWeeks > 0
            ? `Based on ≈ ${formatFixed(inputs.workingWeeks, 2)} active weeks / year`
            : '—'
        },
        {
          label: 'Active day',
          base: summary.dailyBase,
          buffered: summary.dailyBuffered,
          basis: Number.isFinite(inputs.workingDaysPerYear) && inputs.workingDaysPerYear > 0
            ? `Based on ≈ ${formatFixed(inputs.workingDaysPerYear, 2)} active days / year`
            : '—'
        }
      ];

      const rowsMarkup = rows
        .map(row => {
          const baseDisplay = Number.isFinite(row.base) ? formatCurrency(currencySymbol, row.base) : '—';
          const bufferedDisplay = Number.isFinite(row.buffered) ? formatCurrency(currencySymbol, row.buffered) : '—';
          return `
            <tr>
              <th scope="row">${row.label}</th>
              <td>${baseDisplay}</td>
              <td>${bufferedDisplay}</td>
              <td>${row.basis}</td>
            </tr>
          `;
        })
        .join('');

      const bufferLabel = Number.isFinite(summary.bufferPercent) ? formatFixed(summary.bufferPercent, 1) : '0';

      return `
        <div class="card">
          <table>
            <caption>
              Gross revenue needed (base vs. safety margin +${bufferLabel}%)
            </caption>
            <thead>
              <tr>
                <th scope="col">Target</th>
                <th scope="col">Base revenue</th>
                <th scope="col">With margin</th>
                <th scope="col">Basis</th>
              </tr>
            </thead>
            <tbody>
              ${rowsMarkup}
            </tbody>
          </table>
        </div>
      `;
    }

    function render() {
      const inputs = getInputs();
      const summary = computeRevenueSummary(inputs);

      latestCurrencySymbol = inputs.currencySymbol;
      latestRevenueSummary = summary;

      const tableMarkup = buildRevenueSummaryTable(summary, inputs.currencySymbol, inputs);
      tablesContainer.innerHTML = tableMarkup;
      scheduleTablesLayoutUpdate();

      latestResults = [];

      if (summary && Number.isFinite(summary.baseRevenue)) {
        latestResults = [
          {
            label: 'Annual total',
            base: summary.baseRevenue,
            buffered: summary.bufferedRevenue,
            basis: 'Includes fixed and estimated variable costs.'
          },
          {
            label: 'Active month',
            base: summary.monthlyBase,
            buffered: summary.monthlyBuffered,
            basis: Number.isFinite(inputs.activeMonths) && inputs.activeMonths > 0
              ? `≈ ${formatFixed(inputs.activeMonths, 2)} active months / year`
              : ''
          },
          {
            label: 'Active week',
            base: summary.weeklyBase,
            buffered: summary.weeklyBuffered,
            basis: Number.isFinite(inputs.workingWeeks) && inputs.workingWeeks > 0
              ? `≈ ${formatFixed(inputs.workingWeeks, 2)} active weeks / year`
              : ''
          },
          {
            label: 'Active day',
            base: summary.dailyBase,
            buffered: summary.dailyBuffered,
            basis: Number.isFinite(inputs.workingDaysPerYear) && inputs.workingDaysPerYear > 0
              ? `≈ ${formatFixed(inputs.workingDaysPerYear, 2)} active days / year`
              : ''
          }
        ];
      }

      closeActiveInfoIcon();
      enhanceAllInfoIcons();
      renderAssumptions(inputs, summary);
    }

    function renderAssumptions(inputs, summary) {
      if (!assumptionsList) {
        return;
      }

      const {
        targetNet,
        targetNetPerWeek,
        targetNetPerMonth,
        targetNetAveragePerWeek,
        targetNetAveragePerMonth,
        taxRate,
        fixedCosts,
        variableCostPerClass,
        annualVariableCosts,
        vatRate,
        bufferPercent,
        currencySymbol,
        monthsOff,
        weeksOffPerCycle,
        daysOffPerWeek,
        workingDaysPerWeek,
        workingDaysPerYear,
        workingWeeks,
        activeMonths,
        activeMonthShare,
        weeksShare
      } = inputs;

      const activeMonthPercentage = activeMonthShare * 100;
      const activeWeeksPercentage = weeksShare * 100;
      const workingWeeksPerCycle = 4 * weeksShare;

      const targetPerWeekDisplay = Number.isFinite(targetNetPerWeek)
        ? formatCurrency(currencySymbol, targetNetPerWeek)
        : '—';
      const targetPerMonthDisplay = Number.isFinite(targetNetPerMonth)
        ? formatCurrency(currencySymbol, targetNetPerMonth)
        : '—';
      const targetAveragePerWeekDisplay = Number.isFinite(targetNetAveragePerWeek)
        ? formatCurrency(currencySymbol, targetNetAveragePerWeek)
        : '—';
      const targetAveragePerMonthDisplay = Number.isFinite(targetNetAveragePerMonth)
        ? formatCurrency(currencySymbol, targetNetAveragePerMonth)
        : '—';

      const listItems = [];

      if (summary && Number.isFinite(summary.baseRevenue)) {
        const baseDisplay = formatCurrency(currencySymbol, summary.baseRevenue);
        const bufferedDisplay = Number.isFinite(summary.bufferedRevenue)
          ? formatCurrency(currencySymbol, summary.bufferedRevenue)
          : '—';
        listItems.push(`Gross revenue needed: ${baseDisplay} (with margin: ${bufferedDisplay})`);
      }

      listItems.push(
        `Net income per year: ${formatCurrency(currencySymbol, targetNet)}`,
        `Net income per active week: ${targetPerWeekDisplay}`,
        `Net income per active month: ${targetPerMonthDisplay}`,
        `Average weekly net income: ${targetAveragePerWeekDisplay}`,
        `Average monthly net income: ${targetAveragePerMonthDisplay}`,
        `Effective income tax rate: ${formatFixed(taxRate * 100, 1)}%`,
        `Fixed annual costs: ${formatCurrency(currencySymbol, fixedCosts)}`,
        `Variable cost per working day: ${formatCurrency(currencySymbol, variableCostPerClass)}`,
        `Estimated annual variable costs: ${formatCurrency(currencySymbol, annualVariableCosts)}`,
        `Months off per year: ${formatFixed(monthsOff, 2)} (≈ ${formatFixed(activeMonths, 2)} active months; ${formatFixed(activeMonthPercentage, 1)}% of the year)`,
        `Weeks off per 4-week cycle: ${formatFixed(weeksOffPerCycle, 2)} (≈ ${formatFixed(workingWeeksPerCycle, 2)} working weeks each cycle; ${formatFixed(activeWeeksPercentage, 1)}% active weeks)`,
        `Days off per week: ${formatFixed(daysOffPerWeek, 2)} (≈ ${formatFixed(workingDaysPerWeek, 2)} working days when active)`,
        `Estimated working weeks per year: ${formatFixed(workingWeeks, 2)}`,
        `Estimated working days per year: ${formatFixed(workingDaysPerYear, 2)}`,
        `Safety margin applied to revenue: ${formatFixed(bufferPercent, 1)}%`,
        `VAT rate: ${formatFixed(vatRate * 100, 1)}%`,
        `Currency symbol: ${currencySymbol}`,
        `Values are rounded to whole currency units for display and CSV export.`
      );

      assumptionsList.innerHTML = listItems.map(item => `<li>${item}</li>`).join('');
    }

    function downloadCsv() {
      if (!latestResults.length) {
        controls.statusMessage.textContent = 'Calculate the revenue summary before exporting CSV.';
        setTimeout(() => {
          controls.statusMessage.textContent = '';
        }, 2500);
        return;
      }

      const header = 'Target,Base gross revenue,With margin,Basis';
      const rows = latestResults.map(entry => {
        const base = Number.isFinite(entry.base) ? Math.round(entry.base) : '';
        const buffered = Number.isFinite(entry.buffered) ? Math.round(entry.buffered) : '';
        const basis = entry.basis ? entry.basis.replace(/,/g, ';') : '';
        return [entry.label, base, buffered, basis].join(',');
      });

      const csvContent = [header, ...rows].join('
');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      const timestamp = new Date().toISOString().slice(0, 10);
      link.download = `business-revenue-summary-${timestamp}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      controls.statusMessage.textContent = 'CSV download started. File lists base and buffered gross revenue targets.';
      setTimeout(() => {
        controls.statusMessage.textContent = '';
      }, 2500);
    }


    [
      { control: controls.targetNet, basis: 'year' },
      { control: controls.targetNetWeek, basis: 'week' },
      { control: controls.targetNetMonth, basis: 'month' },
      { control: controls.targetNetAverageWeek, basis: 'avgWeek' },
      { control: controls.targetNetAverageMonth, basis: 'avgMonth' }
    ].forEach(({ control, basis }) => {
      if (!(control instanceof HTMLInputElement)) return;
      const updateBasis = () => {
        setTargetNetBasis(basis);
      };
      control.addEventListener('input', updateBasis);
      control.addEventListener('change', updateBasis);
    });

    Object.values(controls).forEach(control => {
      if (!(control instanceof HTMLInputElement)) return;
      control.addEventListener('change', event => {
        if (!(event.target instanceof HTMLInputElement)) return;
        commitControlValueToState(event.target);
        render();
      });
      control.addEventListener('input', event => {
        if (!(event.target instanceof HTMLInputElement)) return;
        commitControlValueToState(event.target);
        if (event.target.type === 'text') return;
        render();
      });
    });

    window.addEventListener('resize', scheduleTablesLayoutUpdate);

    controls.recalcButton.addEventListener('click', render);
    controls.downloadCsv.addEventListener('click', downloadCsv);

    initializePersistence();
    initializeCalcStateFromControls();
    render();
  </script>
</body>
</html>
